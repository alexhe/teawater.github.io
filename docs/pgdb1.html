<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<title></title>
	<meta name="generator" content="LibreOffice 4.2.8.2 (Linux)">
	<meta name="author" content="teawater">
	<meta name="created" content="20160920;134713752325826">
	<meta name="changedby" content="teawater">
	<meta name="changed" content="20160920;135421385118271">
	<style type="text/css">
	<!--
		@page { margin: 2cm }
		p { margin-bottom: 0.25cm; line-height: 120% }
	-->
	</style>
</head>
<body lang="zh-CN" dir="ltr">
<p style="margin-bottom: 0cm; line-height: 100%">移植<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB(1)
arch</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame
v0.4</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">teawater&lt;teawater@gmail.com&gt;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">修改记录：</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">v0.4</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-06-24</span></font></font>，增加<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5.1</span></font></font>中落下的内容。</p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-06-25</span></font></font>，修改<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5.3</span></font></font>中的错误。</p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-06-25</span></font></font>，修改<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5.4</span></font></font>中的错误。</p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-06-25</span></font></font>，修改<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5.5</span></font></font>中的错误。</p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-06-29</span></font></font>，修改<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.2</span></font></font>中的一些语句。</p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-06-29</span></font></font>，修改<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.4</span></font></font>中的错误。</p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-07-01</span></font></font>，修改<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.8</span></font></font>中的一些语句。</p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-07-01</span></font></font>，修改<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.9</span></font></font>中的一些语句。</p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-07-03</span></font></font>，修改<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">8.1</span></font></font>中的错误。</p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-07-03</span></font></font>，修改<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">8.2</span></font></font>中的一些语句。</p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-07-06</span></font></font>，修改<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">8.3</span></font></font>中的一些语句。</p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-07-09</span></font></font>，修改<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">9.3.2</span></font></font>中的一些语句。</p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-07-10</span></font></font>，修改<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">9.3.3</span></font></font>中的一些语句。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">v0.3</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-04-01</span></font></font>，增加了第<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">9</span></font></font>章<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sigtramp
frame</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-03-22</span></font></font>，修改了对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">STEP_SKIPS_DELAY
(pc)</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">STEP_SKIPS_DELAY_P</span></font></font>的介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-03-21</span></font></font>，修改了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">set_gdbarch_software_single_step</span></font></font>的介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-02-25</span></font></font>，修改了第<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1</span></font></font>章中的一些错误。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">v0.2</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-02-20</span></font></font>，增加了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">set_gdbarch_regset_from_core_section</span></font></font>的介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-02-12</span></font></font>，增加了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">set_gdbarch_cannot_fetch_register</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">set_gdbarch_cannot_store_register</span></font></font>的介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%">                   
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sigtramp
frame</span></font></font>相关部分没有进行介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">v0.1</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-01-23</span></font></font>，增加第<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7</span></font></font>章<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的介绍。增加第<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">8</span></font></font>章<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy
frame</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">v0.0</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-01-09</span></font></font>，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">v0.0</span></font></font>版本编写完成，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy
frame</span></font></font>相关部分没有进行介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2005-11-19</span></font></font>，文档创建。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">目录</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1.</span></font></font>写在前面</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2.GDB/config.sub</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.GDB/gdb/configure.tgt</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">4.GDB/gdb/config/ARCH/TARGET.mt</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5.GDB/gdb/ARCH-tdep.c
GDB/gdb/ARCH-TARGET-tdep.c</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5.1.</span></font></font>综述</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5.2.GDB/gdb/ARCH-tdep.c</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5.3.GDB/gdb/ARCH-TARGET-tdep.c</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5.4.gdbarch_register_osabi_sniffer</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5.5.gdbarch</span></font></font>设置函数</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">6.GDB/gdb/config/ARCH/tm-ARCH.h
GDB/gdb/config/ARCH/tm-TARGET.h</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">6.1.</span></font></font>综述</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">6.2.</span></font></font>宏定义</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.frame</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.1.</span></font></font>概述</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.2.struct
frame_info</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.3.struct
frame_id</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.4.</span></font></font>取得当前指令对应函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_info</span></font></font>信息</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.5.</span></font></font>取得指定<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_info</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_id</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.6.</span></font></font>取得指定<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_info</span></font></font>对应的函数返回地址</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.7.</span></font></font>取得指定<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的高一级<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的函数地址</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.8.</span></font></font>跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>相关的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>设置函数</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.9.struct
frame_unwind</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">8.dummy
frame</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">8.1.</span></font></font>概述</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">8.2.struct
value *call_function_by_hand (struct value *function, int nargs,
struct value **args)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">8.3.</span></font></font>跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy
frame</span></font></font>相关的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>设置函数</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">9.sigtramp
frame</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">9.1.</span></font></font>概述</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">9.2.</span></font></font>普通分析法</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">9.3.tramp_frame_prepend_unwinder</span></font></font>法</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">9.3.1.void
tramp_frame_prepend_unwinder (struct gdbarch *gdbarch, const struct
tramp_frame *tramp_frame)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">9.3.2.struct
tramp_frame</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">9.3.3.static
int tramp_frame_sniffer (const struct frame_unwind *self, struct
frame_info *next_frame, void **this_cache)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">9.3.4.static
struct trad_frame_cache *tramp_frame_cache (struct frame_info
*next_frame, void **this_cache)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1.</span></font></font>写在前面</p>
<p style="margin-bottom: 0cm; line-height: 100%">本文针对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB-6.3</span></font></font>进行编写。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">LIBBFD</span></font></font>是一套用来分析二进制文件的库，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>用其来对二进制文件进行分析，具体关于<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">LIBBFD</span></font></font>可以参见<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">http://www.gnu.org/software/binutils/manual/bfd-2.9.1/bfd.html</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>中，用来表示一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">arch</span></font></font>最核心部分就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>结构，其中包含着很多函数指针和变量。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>初始化以及读入新的可执行文件的时候，将调用相应代码（个人认为编写这部分代码以及用来给<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>结构中函数指针赋值是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">arch</span></font></font>移植的主要工作），产生<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>结构的变量，将相应<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">arch</span></font></font>相关的函数地址和变量初始化在其中，并将其地址存在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">current_gdbarch</span></font></font>这个指针中。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>进行调试的时候，可以通过访问<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">current_gdbarch</span></font></font>中的函数指针和变量来达到进行<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">arch</span></font></font>相关调试的目的。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">还有一部分跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>有关的设置，在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/config/ARCH/tm-TARGET.h</span></font></font>进行一些宏定义来进行设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>的运行行为。</p>
<p style="margin-bottom: 0cm; line-height: 100%">有一部分宏定义会在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/gdbarch.h</span></font></font>定义成<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">current_gdbarch</span></font></font>定义在一起，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>调用这部分宏实际上就调用了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">current_gdbarch</span></font></font>中的内容，所以这部分的宏既可以通过设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>结构来实现也可以通过设置宏的方式来实现。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">stack
frame</span></font></font>，也就是栈结构，个人觉得跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>相关的部分是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>结构中最重要的部分，其在调试进行中起比较重要的作用，但是在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB
Internals</span></font></font>中相关章节是空着的，因此我决定介绍一下<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>，这样也对编写初始化<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>相关代码有帮助。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">下面是本文将使用的缩写：</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDBINT
                 GDB Internals Manual</span></font></font>的缩写。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB
                    </span></font></font>指<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>源文件目录。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH
                   </span></font></font>体系结构名称。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET
                 </span></font></font>体系结构下的调试目标，一般是一种操作系统，比如<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">bfd_architecture
       </span></font></font>定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">LIBBFD</span></font></font>中用来描述<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的枚举类型。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdb_osabi
              </span></font></font>定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>中用来描述当前操作系统的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ABI</span></font></font>的枚举类型，其具体分类可以见<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDBINT
9.1</span></font></font>节。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2.GDB/config.sub</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这是一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">shell</span></font></font>文件，其作用是在运行<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">configure</span></font></font>的时候将用户指定的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">target</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">host</span></font></font>转化成标准的字符串格式。</p>
<p style="margin-bottom: 0cm; line-height: 100%">这个文件可以以后面跟一个要转化的字符串的形式被调用，输出转化后的字符串，可以很方便的进行测试。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">这个文件主要分为以下几个部分：</p>
<p style="margin-bottom: 0cm; line-height: 100%">第一部分，将用户输入的结构参数分成前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$basic_machine</span></font></font>和后<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$os</span></font></font>两部分。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第二部分，对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$os</span></font></font>也就是后面的操作系统相关的字段进行分析和处理。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第三部分，对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$basic_machine</span></font></font>进行分析和处理，如果是要增加一个芯片的支持，就在这里增加分析和处理，有时候也对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$os</span></font></font>进行处理。一般来说增加一个如果在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>名称后面没跟任何文件类型的则给<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$basic_machine</span></font></font>增加一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;-unknown&quot;</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第四部分，对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$os</span></font></font>进行进一步的分析和处理。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第五部分，根据<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$basic_machine</span></font></font>对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$os</span></font></font>进行设置。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第六部分，如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$basic_machine</span></font></font>是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">*-unknown</span></font></font>的形式，则根据<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$os</span></font></font>得到其<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$vendor</span></font></font>，也就是制造商，然后将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$basic_machine</span></font></font>中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">unknown</span></font></font>替换成<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$vendor</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第七部分，打印<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$basic_machine$os</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.GDB/gdb/configure.tgt</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个文件跟运行<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">configure</span></font></font>时设置的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">target</span></font></font>有关。这个文件主要作用是根据上面文件得到的字符串得到编译需要的一些信息取得编译需要的信息。</p>
<p style="margin-bottom: 0cm; line-height: 100%">其是在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/configure</span></font></font>中被调用，在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/configure</span></font></font>中先将从<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/config.sub</span></font></font>得到的信息存在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$target</span></font></font>中，然后将其中三部分存放在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$target_cpu</span></font></font>、<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$target_vendor</span></font></font>、<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$target_os</span></font></font>中。然后在其包含的文件<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/configure.tgt</span></font></font>进行分析。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">这个文件首先根据<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$target_cpu</span></font></font>来取得<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$gdb_target_cpu</span></font></font>的值。如果你的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CPU</span></font></font>不象<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">mips</span></font></font>那样含有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">mipsel</span></font></font>类的值，就不用对这段进行修改。这个值将作为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的值。</p>
<p style="margin-bottom: 0cm; line-height: 100%">后面一段根据<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$target</span></font></font>来取得<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$gdb_target</span></font></font>的值，其就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>的值。一般来说这个值使用操作系统的名称。</p>
<p style="margin-bottom: 0cm; line-height: 100%">最后一段根据<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$target</span></font></font>来取得<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">$gdb_osabi</span></font></font>的值，这个值是系统<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ABI</span></font></font>的值，这个值最终将被设置为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB_OSABI_DEFAULT</span></font></font>，也就是系统<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ABI</span></font></font>的默认值。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">4.GDB/gdb/config/ARCH/TARGET.mt</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个文件是设置一些编译<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>需要的跟当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>有关的文件。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TDEPFILES=</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个是指定要编译的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.o</span></font></font>文件，后面介绍的跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>有关的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.c</span></font></font>文件编译成的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.o</span></font></font>文件需要在这里指出，而那个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.c</span></font></font>文件使用的一些函数相关的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.o</span></font></font>文件也需要在这里指定。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DEPRECATED_TM_FILE=</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个是指定描述<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>的头文件，一般来说这个头文件的写法为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tm-TARGET.h</span></font></font>存放在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/config/ARCH/</span></font></font>目录中，具体内容将在后面介绍。注意这里跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDBINT</span></font></font>写的不同，这里的写法是对的，用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDBINT</span></font></font>中介绍的方法无法正常编译。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5.GDB/gdb/ARCH-tdep.c
GDB/gdb/ARCH-TARGET-tdep.c</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5.1.</span></font></font>综述</p>
<p style="margin-bottom: 0cm; line-height: 100%">这两个文件的主要作用就是初始化<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>结构，第一个是跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>相关的，第二个是跟这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>相关的。他们的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.o</span></font></font>文件都将在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET.mt</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TDEPFILES=</span></font></font>中被指定。</p>
<p style="margin-bottom: 0cm; line-height: 100%">个人认为将这两个文件分开的好处是，一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>可能需要支持若干个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>，也可以说是一种芯片支持若干个操作系统；而这些设置中有一部分是跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>有关，另一部分则跟这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>下的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>有关；当同一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的多个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>时，第一个文件<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH-tdep.c</span></font></font>可以重复使用。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在不需要针对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>作<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>以外的设置的时候，可以不包含<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/ARCH-TARGET-tdep.c</span></font></font>文件。例如<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">arm</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">mips</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">embed.mt</span></font></font>都是这种情况。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>中很多<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的这两个文件都对应了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/ARCH-tdep.h</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/ARCH-TARGET-tdep.h</span></font></font>形式的头文件，不过这两个头文件主要是保存一些跟这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>相关的私用数据，所以对其的使用可以灵活掌握。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5.2.GDB/gdb/ARCH-tdep.c</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/ARCH-tdep.c</span></font></font>文件的初始化函数是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
_initialize_ARCH_tdep
(void)</span></font></font>，这个函数在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>启动的时候将被调用，这里最主要的就是对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_register</span></font></font>函数的调用，当然如果需要也可以在这个函数中增加一些命令。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
gdbarch_register (enum bfd_architecture bfd_architecture,
gdbarch_init_ftype *init, gdbarch_dump_tdep_ftype *dump_tdep)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数的作用就是将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">init</span></font></font>函数指针和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dump_tdep</span></font></font>函数指针标记为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">bfd_architecture</span></font></font>注册到全局链表<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_registry</span></font></font>上。这样当<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>读入类型为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">bfd_architecture</span></font></font>的可执行文件的时候，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">init</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dump_tdep</span></font></font>就将被调用。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">init</span></font></font>函数的作用就是初始化并设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>结构，并将其地址返回。编写这个函数基本上可以参考<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/</span></font></font>目录中其他<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的编写，下面我来基本介绍一下其的编写方法。</p>
<p style="margin-bottom: 0cm; line-height: 100%">基本上头一步就是给<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>结构分配空间，使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_alloc</span></font></font>函数，其第一个参数是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">init</span></font></font>函数指针的参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">info</span></font></font>，第二个参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tdep</span></font></font>是一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_tdep</span></font></font>结构指针，其主要是存储了一些跟这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>相关的私有数据，这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_tdep</span></font></font>结构要定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>相关的几个文件里，可以根据需要随意增加内容。在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_alloc</span></font></font>函数中，其先分配空间，然后将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tdep</span></font></font>以及其他默认的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>参数初始化到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，然后返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%">然后就使用一些函数将这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>相关的函数和数据设置到这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>上，这个将在“<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5.5.gdbarch</span></font></font>设置函数”进行详细的介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%">最后调用“<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_init_osabi
(info,
gdbarch);”</span></font></font>，这个函数的作用是调用后面介绍的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/ARCH-TARGET-tdep.c</span></font></font>通过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_register_osabi</span></font></font>注册跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>相关的初始化函数。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dump_tdep</span></font></font>函数主要是用来显示这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>中一些私有的例如<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tdep</span></font></font>的信息，其被<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/gdbarch.c:gdbarch_dump</span></font></font>函数调用，这个函数当执行<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>命令“<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">maintenance
print architecture”</span></font></font>的时候被调用到，主要就是用来显示<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>的信息。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5.3.GDB/gdb/ARCH-TARGET-tdep.c</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/ARCH-TARGET-tdep.c</span></font></font>文件初始化函数是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
_initialize_ARCH_TARGET_tdep
(void)</span></font></font>，这个函数在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>启动的时候将被调用，这里最主要的就是对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_register_osabi</span></font></font>函数的调用，当然如果需要也可以在这个函数中增加一些命令。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
gdbarch_register_osabi (enum bfd_architecture arch, unsigned long
machine, enum gdb_osabi osabi, void (*init_osabi)(struct
gdbarch_info, struct gdbarch *))</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数的作用是将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">init_osabi</span></font></font>函数指针标记为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">arch</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">osabi</span></font></font>注册到全局链表<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdb_osabi_handler_list</span></font></font>上。这个函数将被前面提到过的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_init_osabi</span></font></font>函数调用。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">init_osabi</span></font></font>函数的作用就是根据操作系统的特性对前面<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">init</span></font></font>中分配和设置的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>进行进一步的初始化。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5.4.gdbarch_register_osabi_sniffer</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
gdbarch_register_osabi_sniffer (enum bfd_architecture arch, enum
bfd_flavour flavour, enum gdb_osabi (*sniffer)(bfd *abfd))</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数一般在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">_initialize_ARCH_tdep</span></font></font>或者<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">_initialize_ARCH_TARGET_tdep</span></font></font>中调用，其主要目的是因为二进制可执行文件的格式中对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OS
ABI</span></font></font>的描述并不一定能跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdb_osabi</span></font></font>对应的上，所以这里就是注册一个函数来帮助<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>判断当前文件使用的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdb_osabi</span></font></font>类型。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在这个函数中<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">arch</span></font></font>表示<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">flavour</span></font></font>是定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">LIBBFD</span></font></font>中的对可执行文件的描述，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sniffer</span></font></font>是要注册的函数指针。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sniffer</span></font></font>函数要根据传递来的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">LIBBFD</span></font></font>的文件指针对当前读入的二进制可执行文件进行分析，并将得到的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdb_osabi</span></font></font>返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5.5.gdbarch</span></font></font>设置函数</p>
<p style="margin-bottom: 0cm; line-height: 100%">因为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/ARCH-tdep.c</span></font></font>中注册的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">init</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/ARCH-TARGET-tdep.c</span></font></font>中注册的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">init_osabi</span></font></font>设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>的函数属于同一系列，所以将一起在下面进行介绍，这些函数的大部分都在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/gdbarch.c</span></font></font>中。有一部分函数是跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>有关的，将在后面关于<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的章节再进行介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDBINT
9.10</span></font></font>介绍了一些对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>进行设置的宏定义，而在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/gdbarch.h</span></font></font>中可以看到，下面这些函数设置在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>结构中的函数和变量最终将被定义在相关的宏中来实现调用，所以<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDBINT
9.10</span></font></font>中关于宏的介绍可以作为相关<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>初始化函数的介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_num_regs (struct gdbarch *gdbarch, int num_regs)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的寄存器数量<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">num_regs</span></font></font>到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">NUM_REGS</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_register_type (struct gdbarch *gdbarch,
gdbarch_register_type_ftype *register_type)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_register_type_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的这个函数的作用是根据其参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">reg_nr</span></font></font>指定的寄存器号码确定寄存器，将这个寄存器对应的类型返回，这些类型定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/gdbtypes.c</span></font></font>中。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_register_name (struct gdbarch *gdbarch,
gdbarch_register_name_ftype *register_name)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_register_name_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">REGISTER_NAME</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的这个函数的作用是根据其参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regnr</span></font></font>指出的寄存器序号返回相应的寄存器名称。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_pc_regnum (struct gdbarch *gdbarch, int pc_regnum)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>寄存器序号<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">pc_regnum</span></font></font>到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC_REGNUM</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_sp_regnum (struct gdbarch *gdbarch, int sp_regnum)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SP</span></font></font>寄存器序号<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sp_regnum</span></font></font>到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SP_REGNUM</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_cannot_fetch_register (struct gdbarch *gdbarch,
gdbarch_cannot_fetch_register_ftype *cannot_fetch_register);</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_cannot_fetch_register_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CANNOT_FETCH_REGISTER</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的这个函数的作用是判断其参数指定的寄存器在本地调试<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ptrace(</span></font></font>关于本地调试见移植<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB(2))</span></font></font>的时候是否是不能读取的，如果是则返回真。</p>
<p style="margin-bottom: 0cm; line-height: 100%">因为这个项目跟本地调试的关系更密切，所以也有将宏<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CANNOT_FETCH_REGISTER</span></font></font>定义到本地调试目标头文件<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/config/ARCH/nm-TARGET.h</span></font></font>中的方式。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_cannot_store_register (struct gdbarch *gdbarch,
gdbarch_cannot_store_register_ftype *cannot_store_register)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_cannot_store_register_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CANNOT_STORE_REGISTER</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的这个函数的作用是判断其参数指定的寄存器在本地调试<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ptrace(</span></font></font>关于本地调试见移植<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB(2))</span></font></font>的时候是否是不能设置的，如果是则返回真。</p>
<p style="margin-bottom: 0cm; line-height: 100%">因为这个项目跟本地调试的关系更密切，所以也有将宏<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CANNOT_FETCH_REGISTER</span></font></font>定义到本地调试目标头文件<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/config/ARCH/nm-TARGET.h</span></font></font>中的方式。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_fp0_regnum (struct gdbarch *gdbarch, int fp0_regnum)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">FP0</span></font></font>寄存器序号<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">fp0_regnum</span></font></font>到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">FP0_REGNUM</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_read_pc (struct gdbarch *gdbarch, gdbarch_read_pc_ftype
*read_pc)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_read_pc_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET_READ_PC</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET_READ_PC_P</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的这个函数的作用是通过用户自定义的方式来对调试进程进行<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>寄存器的读取，如果已经用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">set_gdbarch_pc_regnum</span></font></font>设置了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>寄存器的序号，而且<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>寄存器可以通过普通方式读取到，则不需要注册这个函数。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_write_pc (struct gdbarch *gdbarch, gdbarch_write_pc_ftype
*write_pc)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_write_pc_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET_WRITE_PC</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的这个函数的作用是通过用户自定义的方式来对调试进程进行<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>寄存器的设置，如果已经用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">set_gdbarch_pc_regnum</span></font></font>设置了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>寄存器的序号，而且<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>寄存器可以通过普通方式设置，则不需要注册这个函数。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_read_sp (struct gdbarch *gdbarch, gdbarch_read_sp_ftype
*read_sp)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_read_sp_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET_READ_SP</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET_READ_SP_P</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的这个函数的作用是通过用户自定义的方式来对调试进程进行<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SP</span></font></font>寄存器的读取，如果已经用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">set_gdbarch_sp_regnum</span></font></font>设置了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SP</span></font></font>寄存器的序号，而且<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SP</span></font></font>寄存器可以通过普通方式读取到，则不需要注册这个函数。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_breakpoint_from_pc (struct gdbarch *gdbarch,
gdbarch_breakpoint_from_pc_ftype *breakpoint_from_pc)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_breakpoint_from_pc_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">BREAKPOINT_FROM_PC</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的这个函数的作用是根据参数中的要插入的断点的地址<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">pcptr</span></font></font>，选择合适的断点指令，并且设置这个断点指令的长度在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">lenptr</span></font></font>中，如果需要的话地址也需要进行修改。例如<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARM</span></font></font>就需要判断插入一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARM</span></font></font>断点指令还是插入一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">THUMB</span></font></font>断点指令。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_inner_than (struct gdbarch *gdbarch,
gdbarch_inner_than_ftype *inner_than)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_inner_than_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">INNER_THAN</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的这个函数是用来比较栈地址。如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的栈是向下增长<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>向内存低地址<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>的，则注册<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_addr_lessthan(lhs</span></font></font>小于<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">rhs</span></font></font>返回真<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>。如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的栈是向上增长<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>向内存高地址<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>的，则注册<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_addr_greaterthan(lhs</span></font></font>大于<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">rhs</span></font></font>返回真<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_skip_prologue (struct gdbarch *gdbarch,
gdbarch_skip_prologue_ftype *skip_prologue)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_skip_prologue_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SKIP_PROLOGUE</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的这个函数的参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">pc</span></font></font>是一个函数的起始地址，函数将返回这个地址对应的函数的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">prologue</span></font></font>的结束地址。<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">prologue</span></font></font>指函数开始分配栈空间、保存寄存器等那部分代码。一般来说这个函数的编写都是先扫描符号表，一般可以通过符号表找到结束地址，如果符号表查找失败就需要反汇编来分析代码取得结束地址<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>个人觉得靠反汇编来来分析这部分可有可无<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>。具体的过程可以参见<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb</span></font></font>目录中<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH-tedp.c</span></font></font>类型文件中的相关代码。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_print_insn (struct gdbarch *gdbarch,
gdbarch_print_insn_ftype *print_insn)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_print_insn_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET_PRINT_INSN</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的这个函数将在运行<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">disassemble</span></font></font>命令的时候被调用，用来对指定的地址进行反汇编。整个这个函数的结构与<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">binutils</span></font></font>中的一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的结构完全一样，可以直接将其目录中文件拷贝到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>目录中使用。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_return_value (struct gdbarch *gdbarch,
gdbarch_return_value_ftype *return_value)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_extract_return_value (struct gdbarch *gdbarch,
gdbarch_extract_return_value_ftype *extract_return_value)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_store_return_value (struct gdbarch *gdbarch,
gdbarch_store_return_value_ftype *store_return_value)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这三个函数分别设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_return_value_ftype</span></font></font>、<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_extract_return_value_ftype</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_store_return_value_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用后面两个注册的函数指针的宏分别是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">EXTRACT_RETURN_VALUE</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">STORE_RETURN_VALUE</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的第一个函数用来取得函数的返回值以及这个返回值的传递方式。</p>
<p style="margin-bottom: 0cm; line-height: 100%">取得返回值的传递方式的方法为通过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_return_value_ftype</span></font></font>类型函数参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">valtype</span></font></font>用宏<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TYPE_CODE</span></font></font>取得函数返回值类型，这些类型是定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/gdbtypes.h</span></font></font>的枚举类型<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">type_code</span></font></font>中，例如<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TYPE_CODE_INT</span></font></font>代表返回值是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">int</span></font></font>。根据这个类型就可以确定返回值的传递方式，这些方式定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/defs.h</span></font></font>中的枚举类型<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">return_value_convention</span></font></font>中。这些类型是：</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">RETURN_VALUE_REGISTER_CONVENTION</span></font></font>表示返回值通过一个或者多个寄存器返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">RETURN_VALUE_STRUCT_CONVENTION</span></font></font>表示调用函数会传递一个隐含的参数传递一个用来传递返回值的指针。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">RETURN_VALUE_ABI_RETURNS_ADDRESS</span></font></font>类似<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">RETURN_VALUE_STRUCT_CONVENTION</span></font></font>，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ABI</span></font></font>保证被调用函数将返回值放到一个定义明确的位置。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">RETURN_VALUE_ABI_PRESERVES_ADDRESS</span></font></font>也类似<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">RETURN_VALUE_STRUCT_CONVENTION</span></font></font>，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ABI</span></font></font>保证返回值的地址放到一个定义明确的位置。</p>
<p style="margin-bottom: 0cm; line-height: 100%">一般情况下<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TYPE_CODE_STRUCT</span></font></font>、<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TYPE_CODE_UNION</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TYPE_CODE_ARRAY</span></font></font>使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">RETURN_VALUE_STRUCT_CONVENTION</span></font></font>，其他用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">RETURN_VALUE_REGISTER_CONVENTION</span></font></font>，当然具体情况要由<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ABI</span></font></font>决定。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在要取得函数返回值的时候<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_return_value_ftype</span></font></font>类型函数的参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">readbuf</span></font></font>为非空，通过将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regcache</span></font></font>中的值存入这个参数就可以得到返回值。要设置函数的返回值，则参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">writebuf</span></font></font>为非空，通过将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">writebuf</span></font></font>中的值存入<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regcache</span></font></font>中设置返回值。</p>
<p style="margin-bottom: 0cm; line-height: 100%">如果编写一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_return_value_ftype</span></font></font>函数完成了所有的功能，则不需要设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_extract_return_value_ftype</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_store_return_value_ftype</span></font></font>函数。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_return_value_ftype</span></font></font>函数指针在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>初始化的时候设置的默认值是函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">legacy_return_value</span></font></font>，这个函数将调用宏<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">EXTRACT_RETURN_VALUE</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">STORE_RETURN_VALUE</span></font></font>，也就是将调用后两个注册的函数。如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_return_value_ftype</span></font></font>函数使用的默认值，则需要设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_extract_return_value_ftype</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_store_return_value_ftype</span></font></font>函数。</p>
<p style="margin-bottom: 0cm; line-height: 100%">这几个函数的编写可以参照<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/arch-utils.c</span></font></font>中的第一个参数的默认值<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">legacy_return_value</span></font></font>，以及<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/</span></font></font>目录中<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH-tdep.c</span></font></font>类似文件中同样类型的函数。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">从这里开始的介绍的函数一般来说是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>相关的，所以一般情况下他们在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/ARCH-TARGET-tdep.c</span></font></font>中进行注册，当然要具体情况具体分析。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_software_single_step (struct gdbarch *gdbarch,
gdbarch_software_single_step_ftype *software_single_step)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_software_single_step_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SOFTWARE_SINGLE_STEP</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SOFTWARE_SINGLE_STEP_P</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">设置这个函数就表明当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>不支持单步执行，需要通过这个函数提供的软单步功能来实现单步。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的这个函数的作用在当前指令执行的下一条指令插入<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>参数非<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0)</span></font></font>和删除<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>参数为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0)</span></font></font>断点。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注意如果是跳转类的指令则还需要先对指令进行反汇编，对条件跳转还要根据将要执行指令的条件判断出其是否真要进行跳转，判断出下一条指令的地址。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_get_longjmp_target (struct gdbarch *gdbarch,
gdbarch_get_longjmp_target_ftype *get_longjmp_target)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_get_longjmp_target_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GET_LONGJMP_TARGET</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GET_LONGJMP_TARGET_P</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的这个函数的作用是计算出<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">longjmp</span></font></font>要跳转到的地址并存在函数的参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">pc</span></font></font>中，如果成功返回<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，失败返回非<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>。一般来说这个函数的编写方法是分析存放<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">longjump</span></font></font>跳转目标的缓存，将目标地址取出就可以。具体的过程可以参见<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb</span></font></font>目录中<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH-tedp.c</span></font></font>类型文件中的相关代码。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_skip_solib_resolver (struct gdbarch *gdbarch,
gdbarch_skip_solib_resolver_ftype *skip_solib_resolver)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_skip_solib_resolver_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SKIP_SOLIB_RESOLVER</span></font></font>，不过这个宏好像已经被从<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>的代码中去掉了，现在都是通过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_skip_solib_resolver</span></font></font>进行调用。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的这个函数是用来跳过参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">pc</span></font></font>后面的动态连接器符号定义函数，如果这个函数的参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">pc</span></font></font>在动态连接器符号定义函数中的时候，返回动态连接器符号定义函数后面的地址，如果不是则返回<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>。一般来说这个工作需要对符号表进行分析来实现。</p>
<p style="margin-bottom: 0cm; line-height: 100%">如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>使用的是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GLIBC</span></font></font>则可以直接注册<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">glibc_skip_solib_resolver</span></font></font>函数，如果使用这个函数的话需要在文件中包含<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">glibc-tdep.h</span></font></font>头文件，同时在前面提到的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/config/ARCH/TARGET.mt</span></font></font>中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TDEPFILES=</span></font></font>项目中包含<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">glibc-tdep.o</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_skip_trampoline_code (struct gdbarch *gdbarch,
gdbarch_skip_trampoline_code_ftype *skip_trampoline_code)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_skip_trampoline_code_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SKIP_TRAMPOLINE_CODE</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>在调用函数和被调用函数之间有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trampolines</span></font></font>代码<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>跳板代码，对其介绍可以见<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">http://www.science.uva.nl/~mes/jargon/t/trampoline.html)</span></font></font>，则可以注册这个函数用来跳过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trampolines</span></font></font>代码。这个函数的参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">pc</span></font></font>就是当前的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>寄存器的值，如果这个函数返回非<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>则就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trampolines</span></font></font>代码后面普通函数的地址，如果返回<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>则表示执行不成功。</p>
<p style="margin-bottom: 0cm; line-height: 100%">如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trampolines</span></font></font>代码是跟动态链接库有关的，可以注册标准函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/minsyms.c:find_solib_trampoline_target</span></font></font>来实现需要的功能。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_in_solib_return_trampoline (struct gdbarch *gdbarch,
gdbarch_in_solib_return_trampoline_ftype *in_solib_return_trampoline)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_in_solib_return_trampoline_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">IN_SOLIB_RETURN_TRAMPOLINE</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的这个函数是用来确定参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">pc</span></font></font>指定的地址是否在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trampolines</span></font></font>代码中，如果是就返回非<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，不是就返回<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，其参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">name</span></font></font>表示当前所在的函数名称。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">其实还有一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">IN_SOLIB_CALL_TRAMPOLINE(</span></font></font>设置函数是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">set_gdbarch_in_solib_call_trampoline)</span></font></font>，但是其实际已经没有再在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>中被调用，所以不进行介绍，也不建议使用那个选项。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_solib_svr4_fetch_link_map_offsets (struct gdbarch *gdbarch,
struct link_map_offsets *(*func) (void))</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">struct
link_map_offsets *(*func)
(void)</span></font></font>类型的函数到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中。调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SVR4_FETCH_LINK_MAP_OFFSETS</span></font></font>。如果要使用设置函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">set_solib_svr4_fetch_link_map_offsets</span></font></font>则要在文件中<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">solib-svr4.h</span></font></font>头文件，同时在前面提到的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/config/ARCH/TARGET.mt</span></font></font>中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TDEPFILES=</span></font></font>项目中包含<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">solib-svr4.o</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">当你的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>支持<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SVR4</span></font></font>共享库的时候，需要注册的这个函数用来初始化<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SVR4</span></font></font>共享库的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">link_map_offsets</span></font></font>结构。</p>
<p style="margin-bottom: 0cm; line-height: 100%">如果你的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>是标准的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ILP32</span></font></font>结构<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>代表<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">integer/long/pointer</span></font></font>是
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">32</span></font></font>位<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>可以直接注册<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/solib-svr4.c:svr4_ilp32_fetch_link_map_offsets</span></font></font>函数，如果是标准的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">LP64</span></font></font>结构<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>代表<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">long/pointer</span></font></font>是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">64</span></font></font>位<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>可以直接注册<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/solib-svr4.c:svr4_lp64_fetch_link_map_offsets</span></font></font>函数。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_regset_from_core_section (struct gdbarch *gdbarch,
gdbarch_regset_from_core_section_ftype regset_from_core_section)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_regset_from_core_section_ftype</span></font></font>类型的函数到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的这个函数会根据某个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">section</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sect_name</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sect_size</span></font></font>返回合适的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regset</span></font></font>结构，如果没有合适的就返回<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">NULL</span></font></font>。这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regset</span></font></font>结构可以是用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/regset.c:regset_alloc</span></font></font>函数分配，也可以使用事先设置好的全局变量。</p>
<p style="margin-bottom: 0cm; line-height: 100%">具体到要注册的函数的代码，主要就是根据<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sect_name</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sect_size</span></font></font>确定返回分析普通寄存器的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regset</span></font></font>结构、浮点寄存器的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regset</span></font></font>结构、扩展浮点寄存器<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(SSE</span></font></font>，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">i386</span></font></font>系列处理器特有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>的
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regset</span></font></font>结构还有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">NULL</span></font></font>。一般来说<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sect_name</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;.reg&quot;</span></font></font>返回普通寄存器的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regset</span></font></font>结构，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sect_name</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;.reg2&quot;</span></font></font>返回浮点寄存器的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regset</span></font></font>结构，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">i386</span></font></font>系列的同时<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sect_name</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;.reg-xfp&quot;</span></font></font>返回扩展浮点寄存器的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regset</span></font></font>结构，其他返回<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">NULL</span></font></font>。当然还要根据实际情况具体问题具体分析。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regset</span></font></font>结构定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/regset.h</span></font></font>文件中，这个结构主要是存储了对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件中数据进行处理的函数的指针。这两个指针分别是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">supply_regset_ftype</span></font></font>类型的函数指针<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">supply_regset</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">collect_regset_ftype</span></font></font>类型的函数指针<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">collect_regset</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">supply_regset</span></font></font>的作用是将参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regnum</span></font></font>指定的寄存器<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">-1</span></font></font>代表是全部寄存器<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>从<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gregs</span></font></font>参数中指定的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件中的寄存器信息进行转化存储到参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regcache</span></font></font>中<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>一般用存储使用函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regcache_raw_supply)</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">collect_regset</span></font></font>的作用是将参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regnum</span></font></font>指定的寄存器<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">-1</span></font></font>代表是全部寄存器<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>从参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regcache</span></font></font>中读出进行转化然后存储到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gregs</span></font></font>参数中指定的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件中的寄存器信息中<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>一般用函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regcache_raw_collect</span></font></font>从<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regcache</span></font></font>进行读取<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">因为这个函数跟本地调试中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件分析关系比较密切，所以对注册的这个函数的使用将在“移植<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB(2)”</span></font></font>中进行详细介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">6.GDB/gdb/config/ARCH/tm-ARCH.h
GDB/gdb/config/ARCH/tm-TARGET.h</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">6.1.</span></font></font>综述</p>
<p style="margin-bottom: 0cm; line-height: 100%">这两个文件后面的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/config/ARCH/tm-TARGET.h</span></font></font>文件中是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>相关的信息，一般其将在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET.mt</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DEPRECATED_TM_FILE=</span></font></font>中被指定。<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">configure</span></font></font>以后，定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DEPRECATED_TM_FILE=</span></font></font>中的文件将被软连接到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/tm.h</span></font></font>文件，这个文件将被<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/defs.h</span></font></font>文件包含，而这个文件将被很多文件包含，所以在在这个文件中设置的宏以及其他的定义最终将被相关的文件包含，达到了设置这些文件的目的。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/config/ARCH/tm-ARCH.h</span></font></font>文件中是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>相关的信息，一般其是被<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的所有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tm-TARGET.h</span></font></font>文件包含的，不过如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>除了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>相关的定义不需要自己再进行什么定义的时候，也可以直接被在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET.mt</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DEPRECATED_TM_FILE=</span></font></font>中指定<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tm-ARCH.h</span></font></font>，这个是可以灵活掌握的。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">6.2.</span></font></font>宏定义</p>
<p style="margin-bottom: 0cm; line-height: 100%">在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5.5</span></font></font>节介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>设置函数的时候，同时就介绍了调用注册上的变量或者函数的宏，这些宏跟下面将要介绍的宏一样，都可以在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tm-ARCH.h</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tm-TARGET.h</span></font></font>中进行设置。</p>
<p style="margin-bottom: 0cm; line-height: 100%">要注意的是很多宏都是跟“宏<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">_P”</span></font></font>名称的宏一起使用的，这个“宏<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">_P”</span></font></font>形式的宏是用来判断名称中的那个宏是否使用，所以使用设置这个宏一定要同时设置“宏<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">_P”</span></font></font>形式的宏为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">这些宏在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDBINT
9.10</span></font></font>进行了一些介绍，可以作为参考。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">STEP_SKIPS_DELAY
(pc)</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">STEP_SKIPS_DELAY_P</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个宏用来确定<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">pc</span></font></font>地址上的指令是否是一条缓冲槽指令，如果是则返回真。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>用这个宏来判断当前指令是不是缓冲槽指令，然后就会去判断下一条指令也就是缓冲槽中的指令是不是断点，如果是则表明当前指令是一条断点指令，因为如果缓冲槽中的是断点指令，发生断点一般的处理是这样，芯片进入管理模式，在芯片返回的时候回到缓冲槽指令而不是回到缓冲槽的地址中，所以就等于是缓冲槽指令发生了断点。</p>
<p style="margin-bottom: 0cm; line-height: 100%">对这个宏的调用是在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/infrun.c:proceed</span></font></font>函数中，其在判断出会有断点的时候，就会设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">oneproc</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1</span></font></font>，用来标明这次执行只会运行一条指令，在下面的处理中如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">oneproc</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1</span></font></font>则就不需要在进程继续运行开始前插入预先设置好的断点。</p>
<p style="margin-bottom: 0cm; line-height: 100%">这里有一个问题，这样表明那个在缓冲槽中的断点指令必须是能被执行的吗？因为如果是条件缓冲槽指令，如果条件不符合，这条断点指令不会被调用，也就不会只执行一条指令，而且没插入断点，这样显然是不对的。但是我们又可以看到，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">MIPS</span></font></font>的判断函数中将条件缓冲槽指令也包含进来，并且也并没有通过判断当前芯片情况的形式来确定是否反正真，这是怎么回事？原来在下面，将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">oneproc</span></font></font>也跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">step</span></font></font>与在一起传递给了调用实际的启动函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/infrun.c:resume</span></font></font>，作为其的参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">step</span></font></font>，所以在设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">oneproc</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1</span></font></font>后不论任何情况，这里只会单步执行，所以不会对正常调试有什么影响。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在本文的以前版本中，我曾经提到过“在现在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>源码中只有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">MIPS</span></font></font>用了这个宏，没有别的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>有缓冲槽指令？难道缓冲槽是被<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">MIPS</span></font></font>申请了的专利？”这里的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>源码指的是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB-6.3</span></font></font>，最近我看了一点<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB-6.4</span></font></font>，其中将这两个宏替换成了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_single_step_through_delay</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_single_step_through_delay_p</span></font></font>，当然整体结构变化不大，只是把判断缓冲槽中指令是否是断点指令的工作也放到了这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>相关的函数中进行了。而且<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>支持这个函数的不光有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">MIPS</span></font></font>，还有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CRIS</span></font></font>。具体<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB-6.3</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB-6.4</span></font></font>的差异，我将在本文的后续版本中进行详细的介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">IN_SOLIB_DYNSYM_RESOLVE_CODE
(pc)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个宏用来确定<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">pc</span></font></font>地址是否在动态连接器符号定义函数中，如果是则返回真。</p>
<p style="margin-bottom: 0cm; line-height: 100%">如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>使用的动态链接库已经被<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>支持<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(GDB/gdb/solib-</span></font></font>库名称<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.c)</span></font></font>，则可以不设置这个宏，而是在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tm-TARGET.h</span></font></font>中包含<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">solib.h</span></font></font>头文件，同时在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET.mt</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TDEPFILES=</span></font></font>中包含<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">solib.o</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">solib-</span></font></font>库名称<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.o</span></font></font>来对动态库进行支持。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.frame</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.1.</span></font></font>概述</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">stack
frame</span></font></font>，也就是栈结构，个人认为其主要的功能就是用来确定一条指令所在的函数位置，一个函数中的所有指令的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>结构都是一样的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>用来帮助取得<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>结构的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">-1</span></font></font>级结构是不同的，后面会详细介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">比如<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>使用指令<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">next</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">nexti</span></font></font>的时候，在执行前先会取得当前函数的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>信息，然后在每执行一条指令后取得跟这条指令对应的函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>信息的上一层函数的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>信息，如果这两个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>信息相同则表明执行进入了一个函数，将在前一个函数现在所在函数返回位置设置断点，然后使用连续执行，达到快速通过单步代码执行中函数调用的目的。其中比较以及后面功能的代码在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/infrun.c:handle_inferior_event:2285</span></font></font>行开始。</p>
<p style="margin-bottom: 0cm; line-height: 100%">类似的还有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">finish</span></font></font>指令通过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>信息取得当前函数调用函数位置等。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>分为四种类型，分别是普通<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>结构的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">NORMAL_FRAME</span></font></font>，在通过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>调用程序中某个函数的时候使用的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DUMMY_FRAME</span></font></font>，用在信号处理代码中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SIGTRAMP_FRAME</span></font></font>，用来记录当前指令所在位置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>普通<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>记录的是当前指令所在函数的信息<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>信息的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SENTINEL_FRAME</span></font></font>，他们定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame.h</span></font></font>的枚举类型<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_type</span></font></font>中，后面会在对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>介绍的时候介绍到他们。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.2.struct
frame_info</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个结构中保存了一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的各种信息。其被定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame.c</span></font></font>中，在这个文件之外对这个结构的调用只限于指针，所以这个结构定义在这里就可以。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">其主要的元素有：</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">int
level</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个变量代表<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的等级，当前函数的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的等级是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，这个函数的调用函数的等级是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1</span></font></font>，依此类推。下面都将按照这个方式，按照<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">level</span></font></font>值的高低来区别<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>，称呼他们为高一级和低一级。</p>
<p style="margin-bottom: 0cm; line-height: 100%">有一个特殊的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">level</span></font></font>是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">-1</span></font></font>，一般来说这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">levle</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SENTINEL_FRAME</span></font></font>类型的。其是通过当前指令的信息取得，每条指令一个。因为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>总是需要一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>，所以就需要有这个特殊的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>表示比当前函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>低一级的当前指令的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">const
struct frame_unwind *unwind;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个结构指针是对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_info</span></font></font>进行控制的重要元素，每个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>都是通过将函数指针和变量设置到其上来达到控制<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的目的，具体的这个结构和设置过程将在后面详细介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注意其中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">const</span></font></font>是为了保证这个变量只在初始化设置一次，其他时候设置将报错。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
*prologue_cache;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个指针是给<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">unwind</span></font></font>函数互相传递数据使用，具体使用方式将在后面详细介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">struct
{</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">  <font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">int
p;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">  <font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CORE_ADDR
value;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">}
prev_pc;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个结构中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">value</span></font></font>存储了这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>相关的函数的返回地址，因为这个地址就是比其高一级的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的函数的地址，所以称为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">prev_pc</span></font></font>。<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">p</span></font></font>代表这个值是否有效。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">struct</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">{</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">  <font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CORE_ADDR
addr;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">  <font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">int
p;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">}
prev_func;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个结构中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>存储了比当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>高一级的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>相关的函数的起始地址。<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">p</span></font></font>代表这个值是否有效。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">struct</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">{</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">  <font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">int
p;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">  <font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">struct
frame_id value;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">}
this_id;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个结构是当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ID</span></font></font>，这是用来分辨<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的核心数据，在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2</span></font></font>个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>进行比较的时候，将用这个结构中的数据进行比较。这个结构中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">p</span></font></font>代表整个这个结构是否有效，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_id</span></font></font>结构将在下面介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">struct
frame_info *next;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个指针指向比这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>低一级的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的结构。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">struct
frame_info *prev;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个指针指向比这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>高一级的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的结构。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">int
prev_p;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个变量用来标明<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">prev</span></font></font>指针是否被赋值，在访问<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">prev</span></font></font>以前需要先检查这个变量，如果为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1</span></font></font>可直接访问，如果为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>则需要先取得<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">prev</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">更多的信息可以看相关代码的注释，写的比较详细。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.3.struct
frame_id</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个结构是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ID</span></font></font>，用来区分<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>，定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame.h</span></font></font>中。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">其主要的元素有：</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CORE_ADDR
stack_addr;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>对应函数的栈地址，一般来说就是调用这个函数后，函数进行栈空间分配之前的栈地址。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">unsigned
int stack_addr_p : 1;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">stack_addr</span></font></font>只有在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">stack_addr_p</span></font></font>为真的时候有效。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CORE_ADDR
code_addr;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>对应函数的的起始地址。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">unsigned
int code_addr_p : 1;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">code_addr</span></font></font>只有在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">code_addr_p</span></font></font>为真的时候有效。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CORE_ADDR
special_addr;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">有一些<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的某部分<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">stack_addr</span></font></font>不频繁变化，但是有一个其他地址的变化可以作为标识的补充，则将这个地址设置到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">special_addr</span></font></font>中。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">unsigned
int special_addr_p : 1;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">special_addr</span></font></font>只有在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">special_addr_p</span></font></font>为真的时候有效。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.4.</span></font></font>取得当前指令对应函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_info</span></font></font>信息</p>
<p style="margin-bottom: 0cm; line-height: 100%">使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame.c:get_current_frame</span></font></font>函数。</p>
<p style="margin-bottom: 0cm; line-height: 100%">其的执行过程主要是：</p>
<p style="margin-bottom: 0cm; line-height: 100%">第一，检查当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">target(</span></font></font>跟前面提到的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>不是一个东西，其是被调试目标，介绍可以见<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDBINT
10)</span></font></font>的寄存器、栈和内存进行检查，没有任何一个都将出错。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第一，判断全局变量<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame.c:current_frame</span></font></font>是否为空，如果不为空则返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第二，调用函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame.c:create_sentinel_frame</span></font></font>取得<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sentinel_frame</span></font></font>，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sentinel_frame</span></font></font>就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.2</span></font></font>提到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">level</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">-1</span></font></font>类型是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SENTINEL_FRAME</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">create_sentinel_frame</span></font></font>中，首先给<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_info</span></font></font>结构分配空间，然后将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">level</span></font></font>设置为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">-1</span></font></font>。接着是初始化<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">prologue_cache</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">unwind</span></font></font>，其中<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">prologue_cache</span></font></font>将当前寄存器信息存储其中，而<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">unwind</span></font></font>初始化为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/sentinel-frame.c:sentinel_frame_unwind</span></font></font>。设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">next</span></font></font>为当前初始化的这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_info</span></font></font>结构，保证当需要访问比这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>还低一级的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的时候可以访问到这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>自身。设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_id</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame.c:null_frame_id</span></font></font>，设置这个值保证每次<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_id</span></font></font>的比较都不相等。最后将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第三，通过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/top.c:catch_exceptions</span></font></font>函数调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame.c:unwind_to_current_frame</span></font></font>函数，这个函数会调用函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame.c:get_prev_frame</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">get_prev_frame</span></font></font>中，先作一些检查，然后调用函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame.c:get_prev_frame_1</span></font></font>进行实际的工作。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">get_prev_frame_1</span></font></font>中，这里先检查参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">this_frame-&gt;prev_p</span></font></font>是否为真，如果为真表明<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">this_frame-&gt;prev</span></font></font>已经存在，则直接返回<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">this_frame-&gt;prev</span></font></font>。设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">this_frame-&gt;prev_p</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1</span></font></font>，因为现在要开始设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">this_frame-&gt;prev</span></font></font>了。对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">this_frame</span></font></font>进行一些检查，如果检查没问题则给<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">prev_frame</span></font></font>分配空间，设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">prev_frame-&gt;level</span></font></font>比<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">this_frame-&gt;level</span></font></font>大<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1</span></font></font>，表明比<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">this_frame</span></font></font>高一个级别。最后互相注册到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">prev</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">next</span></font></font>上建立连接，返回<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">prev_frame</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">这样就取得了比<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sentinel_frame</span></font></font>高一级的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>，也就是对应当前函数的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>。将取得的这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>设置到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">current_frame</span></font></font>上。可以注意到这个新取得的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">current_frame</span></font></font>上很多元素都是空的，这是因为当在使用这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_info</span></font></font>中的一部分元素的时候，会先自动检查其是否存在，如果不存在则调用相应函数取得其。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第四，整个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">get_current_frame</span></font></font>函数返回<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">current_frame</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.5.</span></font></font>取得指定<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_info</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_id</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame.c:get_frame_id</span></font></font>函数。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">其的执行过程主要是：</p>
<p style="margin-bottom: 0cm; line-height: 100%">第一，检查<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_info</span></font></font>结构的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">this_id.p</span></font></font>，如果为真表明<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">this_id.value</span></font></font>存在，直接返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第二，检查<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_info</span></font></font>结构中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">unwind</span></font></font>是否为空，如果为空则调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame-unwind.c:frame_unwind_find_by_frame</span></font></font>函数根据当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>低一级的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">next</span></font></font>取得<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">unwind</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind_find_by_frame</span></font></font>中，首先通过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>取得<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构的列表。然后循环依次先调用表中每个元素在其注册的时候注册的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sniffer</span></font></font>函数，然后调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构上自带的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sniffer</span></font></font>函数，如果成功则返回<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构，失败则报错。关于将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构注册到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中的方式将在介绍跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>相关的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>初始化函数的时候，再进行介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第三，调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">this_id</span></font></font>函数指针，取得<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">this_id.value</span></font></font>，设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">this_id.p</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1</span></font></font>，然后返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">取得指定<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_info</span></font></font>的寄存器信息的函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame.c:frame_register_unwind</span></font></font>跟这个函数结构类似，只是将调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">this_id</span></font></font>函数指针换成<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">prev_register</span></font></font>函数指针，所以不作详细的介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.6.</span></font></font>取得指定<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_info</span></font></font>对应的函数返回地址</p>
<p style="margin-bottom: 0cm; line-height: 100%">使用函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame.c:frame_pc_unwind</span></font></font>，因为取得<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_info</span></font></font>对应的函数返回地址是取得比其高一级的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_info</span></font></font>信息的关键，因为取得了这个地址就意味着取得了高一级的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的地址。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数的执行过程主要是：</p>
<p style="margin-bottom: 0cm; line-height: 100%">第一，检查这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">prev_pc.p</span></font></font>是否为真，如果为真则表明<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">prev_pc.value</span></font></font>存在，直接将其返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第二，判断<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>是否设置了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">unwind_pc</span></font></font>函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>这个函数的设置和编写将在跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>相关的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>设置函数章节进行介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>，如果设置了则运行其来取得相关值，然后设置到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">prev_pc.value</span></font></font>返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第三，判断当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的级别是否小于<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，如果小于<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>就表明是前面提到的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sentinel_frame</span></font></font>，则直接通过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">read_pc</span></font></font>取得当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">pc</span></font></font>值设置到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">prev_pc.value</span></font></font>并返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第四，如果都不存在则报错。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">个人认为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_pc_unwind</span></font></font>以及<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">unwind_pc</span></font></font>实在是函数起名的错误典型，明明是取得这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>高一级的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">pc</span></font></font>，却偏偏叫<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_pc_unwind</span></font></font>，很容易让人误以为是取得当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>相关函数起始之用。确实很多<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>之中注册到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">unwind_pc</span></font></font>上的函数是靠取得<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>寄存器中<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">pc</span></font></font>值来实现的，但是这是因为这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>的这个值正好是函数返回地址。以这样的函数名称，再加上很多<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>中的相关代码，很容易让人错误理解这个函数的作用。所以个人认为其应该叫<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_prev_pc_unwind</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">unwind_prev_pc</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.7.</span></font></font>取得指定<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的高一级<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的函数起始地址</p>
<p style="margin-bottom: 0cm; line-height: 100%">使用函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame.c:frame_func_unwind</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数的执行过程主要是：</p>
<p style="margin-bottom: 0cm; line-height: 100%">第一，检查这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">prev_func.p</span></font></font>是否为真，如果为真则表明<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">prev_func.addr</span></font></font>存在，直接将其返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第二，调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame.c:frame_unwind_address_in_block</span></font></font>函数，这个函数主要就是调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_pc_unwind</span></font></font>取得指定<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的函数返回地址，也就是比这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>高一级的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>函数中的一个地址。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第三，调用函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/blockframe.c:get_pc_function_start</span></font></font>通过分析符号信息，用比这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>高一级的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>函数中的一个地址取得这个函数的起始地址，设置到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">prev_func.addr</span></font></font>中，然后返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">个人觉得这个函数起名跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_pc_unwind</span></font></font>有类似的问题。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.8.</span></font></font>跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>相关的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>设置函数</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
frame_unwind_append_sniffer (struct gdbarch *gdbarch,
frame_unwind_sniffer_ftype *sniffer)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind_sniffer_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中。注意这个函数可以在初始化的代码中多次调用来注册多个函数。</p>
<p style="margin-bottom: 0cm; line-height: 100%">每个注册的函数都跟一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构指针相关，其主要作用是在前面介绍过的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind_find_by_frame</span></font></font>函数中依照注册的先后被调用。</p>
<p style="margin-bottom: 0cm; line-height: 100%">一般这个函数会通过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame.c:frame_pc_unwind</span></font></font>函数取得<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">next_frame</span></font></font>也就是比其低一级的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的函数返回地址，也就是当前函数的一个地址，通过这个地址进行分析跟注册的这个函数相关的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构是否符合这个地址相关的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame(</span></font></font>一般来说是执行文件调试信息有这个地址相关的调试信息<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>，如果符合则返回这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构指针，如果不符合则返回<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">NULL</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>的可执行文件支持<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DWARF2</span></font></font>调试格式，可以直接注册<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/dwarf2-frame.c:dwarf2_frame_sniffer</span></font></font>函数，使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DWARF2</span></font></font>格式分析结构<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/dwarf2-frame.c:dwarf2_frame_unwind</span></font></font>对相关信息进行分析。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind_find_by_frame</span></font></font>中，如果最后一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sniffer</span></font></font>函数失败，则函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind_find_by_frame</span></font></font>的执行将出错，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>的执行也会退出，所以建议最后用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind_append_sniffer</span></font></font>注册一个不会进行任何检查而直接返回<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构指针<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sniffer</span></font></font>函数。而跟这个函数相关的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构指针中的函数相对也是最基础的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>分析方式，主要是通过对代码反汇编取得函数行为来确定，将在下面介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构的时候进行详细的介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_unwind_pc (struct gdbarch *gdbarch,
gdbarch_unwind_pc_ftype *unwind_pc)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_unwind_pc_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的这个函数将被<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.6</span></font></font>介绍过的函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame.c:frame_pc_unwind</span></font></font>调用，其将返回参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">next_frame</span></font></font>相关的函数的返回地址。</p>
<p style="margin-bottom: 0cm; line-height: 100%">一般在这个函数中调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame.c:frame_unwind_register_unsigned
</span></font></font>、<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">get_frame_register_signed</span></font></font>等函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>这些函数将调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.5</span></font></font>介绍过的函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame.c:frame_register_unwind)</span></font></font>来取得相应序号寄存器的在栈中的信息，具体取哪个寄存器的数据则需要根据<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_register_unwind</span></font></font>调用的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构中的函数的情况来决定。比如有一些<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>中是取<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>寄存器的值，因为存储在栈中<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>寄存器位置的值就是这个函数的返回地址。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.9.struct
frame_unwind</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个结构定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame-unwind.h</span></font></font>中，其在前面已经被多次提到，其中的指针就是对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>信息进行分析的核心函数。下面将介绍一下这个结构中主要函数指针的作用。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">enum
frame_type type;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这是本章开头提到的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的类型，一般用前面介绍的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind_append_sniffer</span></font></font>函数注册的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构都使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">NORMAL_FRAME</span></font></font>类型。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">因为下面要介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构中的两个函数的编写方法一般来说都是从栈中取得寄存器信息，然后进行处理，所以一般都是先调用一个独立的函数，这个函数是对栈进行分析，然后将结果保存在参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">this_cache</span></font></font>中。</p>
<p style="margin-bottom: 0cm; line-height: 100%">这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">this_cache</span></font></font>指针就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_info</span></font></font>结构中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">prologue_cache</span></font></font>，所以这个指针可以用来保存分析出来的寄存器信息。因为每个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的结构差异很大，所以一般使用例如<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">struct
mips_frame_cache(</span></font></font>定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/mips-tdep.c</span></font></font>中<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>这样的结构来定义<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">*this_cache</span></font></font>指向的内存，一般来说这个结构包含一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CORE_ADDR</span></font></font>类型的值存储当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>对应函数的栈地址，一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/trad-frame.h:trad_frame_saved_reg</span></font></font>结构的指针用来保存其他分析出的寄存器的信息。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">下面是栈分析函数的一般执行结构。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第一步，判断<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">*this_cache</span></font></font>是否为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">NULL</span></font></font>，如果不为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">NULL</span></font></font>，则表明已经被分析过，不需要再进行分析，可以直接使用其中的值。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第二步，调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame.h:FRAME_OBSTACK_ZALLOC</span></font></font>分配内存，参数为这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>结构类型的长度。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第三步，如果当前的结构中定义了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trad_frame_saved_reg</span></font></font>类型结构指针，则需要调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/trad-frame.c:trad_frame_alloc_saved_regs</span></font></font>以<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">next_frame</span></font></font>为参数对这个结构指针进行初始化。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第四步，分析栈信息最主要的就是分析出当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>对应的函数栈地址，就是函数进行栈空间分配之前的栈地址。</p>
<p style="margin-bottom: 0cm; line-height: 100%">如果当前的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>中有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">BP</span></font></font>寄存器，因为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">BP</span></font></font>寄存器存储函数栈地址，在函数调用的时候<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">BP</span></font></font>寄存器将被存入下一个函数的栈中，所以可以通过取得参数中<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">next_frame(</span></font></font>也就是比这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>低一级的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame)</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">BP</span></font></font>值来取得函数栈地址。</p>
<p style="margin-bottom: 0cm; line-height: 100%">如果没有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">BP</span></font></font>寄存器，则取得参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">next_frame</span></font></font>相关函数的栈地址信息<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>一般来说是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SP</span></font></font>寄存器信息<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>，然后通过对当前函数的分析得到这个函数分配的栈空间长度<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>这里是栈分析的最主要工作，使用编译中产生的调试信息，如果没有则只有反汇编代码，在取得长度的同时一般也会分析出哪些寄存器被存在了栈中以及他们的位置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>，将这两个值相加<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>如果栈是递减形式分配<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>就可以得到当前函数栈地址信息。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第五步，栈地址以及对栈中信息分析得到的寄存器信息都要存到前面提到的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">*this_cache</span></font></font>中。如果使用了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trad_frame_saved_reg</span></font></font>类型结构指针存储寄存器信息，则将每个分析到的寄存器用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/trad-frame.c:trad_frame_set_value</span></font></font>来设置其中寄存器的值。</p>
<p style="margin-bottom: 0cm; line-height: 100%">这里要注意如果你在前面介绍过的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">unwind_pc</span></font></font>函数中设置的取用某个寄存器的值作用函数的返回地址，则在这里一定要将这个寄存器的值设置为存在栈中的函数返回值。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_this_id_ftype
*this_id;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">取得参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">next_frame</span></font></font>的高一级的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_id</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">函数的编写方式是首先调用前面提到的栈分析函数得到栈信息，如果你的栈结构比较普通，可以调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/frame.c:frame_id_build</span></font></font>函数取得<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_id</span></font></font>，其的第一个参数使用前面分析得到的栈地址，第二个参数用前面介绍过的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_func_unwind</span></font></font>函数取得<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>相关函数的起始地址就可以。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_prev_register_ftype
*prev_register;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">分解<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(unwind)</span></font></font>出当前这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的寄存器信息<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>被函数存入栈的寄存器信息<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">函数的编写方式是首先调用前面提到的栈分析函数得到栈信息，如果使用了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trad_frame_saved_reg</span></font></font>类型结构指针存储寄存器信息，则将每个分析到的寄存器用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/trad-frame.c:trad_frame_get_prev_register</span></font></font>来设置寄存器的值。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">8.dummy
frame</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">8.1.</span></font></font>概述</p>
<p style="margin-bottom: 0cm; line-height: 100%">在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>中可以用命令<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">call</span></font></font>或者命令<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">print</span></font></font>调用被调试的程序中的函数，调用的方式是先创建一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy
frame(</span></font></font>就是前面介绍过的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DUMMY_FRAME)</span></font></font>，然后以这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy
frame</span></font></font>为基础<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>跟前面提到过的一样，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>任何时候都需要一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame)</span></font></font>调用函数。跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy
frame</span></font></font>相关的一些函数等将在下面进行介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">8.2.struct
value *call_function_by_hand (struct value *function, int nargs,
struct value **args)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数的定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/infcall.c</span></font></font>中，当用户用命令调用某个函数的时候，先会调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/printcmd.c</span></font></font>文件中的函数，这个函数调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/eval.c</span></font></font>中的函数，最终就会调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">call_function_by_hand</span></font></font>函数。这个函数上完成了前面提到的创建<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy
frame</span></font></font>以及调用函数的工作，理解这个函数对理解<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy
frame</span></font></font>非常有帮助，所以要对这个函数进行介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数的第一个参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">function</span></font></font>是要调用函数的描述结构，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">nargs</span></font></font>是函数参数的数量，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">args</span></font></font>是函数参数的值。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">下面来介绍一下这个函数的主要执行过程：</p>
<p style="margin-bottom: 0cm; line-height: 100%">第一步，调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">target_has_execution</span></font></font>检查<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">current_target</span></font></font>是否处于执行中状态，没有则报错返回，因为只有处于执行的中的状态才能调用函数。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第二步，保存一些当前程序的寄存器等信息以及给一些后面需要的指针分配空间。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第三步，调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/regcache.c:read_sp</span></font></font>取得当前栈指针<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>一般来说是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SP</span></font></font>寄存器的信息<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_frame_align_p</span></font></font>函数判断<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>是否设置了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_align</span></font></font>函数指针<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(8.3</span></font></font>介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>，如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>没有设置这个函数指针则跳过下面下栈指针进行处理的代码，直接到第四步，因为这个函数指针将在下面的处理中保证栈仍然按照<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>要求对齐。</p>
<p style="margin-bottom: 0cm; line-height: 100%">处理栈指针首先调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">INNER_THAN(5.5</span></font></font>介绍过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>用来判断栈是递减分配还是递增分配，然后根据情况从栈中分配<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_frame_red_zone_size(8.3</span></font></font>介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>长度的值，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">red
zone</span></font></font>是一部分的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ABI</span></font></font>令函数使用栈空间底部以外的空间的称呼，这部分空间有一个特点是如果在当前函数中再进行函数调用，则这部分空间讲被分配为被被调用函数的空间，则其中数据将被破坏，解决办法是调用函数以前先将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">red
zone</span></font></font>的空间分配到当前函数空间中。现在是我们自己调用函数，所以需要先分配<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">red
zone</span></font></font>。没有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">red
zone</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_frame_red_zone_size</span></font></font>默认被设置为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，也就不进行分配工作。</p>
<p style="margin-bottom: 0cm; line-height: 100%">然后检查空间是否仍然按照要求对齐，如果不对齐则报错退出。</p>
<p style="margin-bottom: 0cm; line-height: 100%">现在检查新取得的栈指针跟原来的栈指针是否相同，如果相同则需要再对栈指针进行先分配<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1</span></font></font>字节然后对齐的操作，这样作的目的在那段代码上面的注释上有比较详细的介绍，我按照我的理解来介绍一下：在很多<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">RISC
ARCH</span></font></font>中，没有参数没有返回值的函数往往形成没有栈变化的函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>因为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">RISC
ARCH</span></font></font>好像倾向于把函数返回地址存到一个特定寄存器，相比较<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CISC</span></font></font>比如<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">X86</span></font></font>是把函数返回地址放到栈中则不会出现这种问题<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>，前面我们介绍过栈指针是产生用来比较栈的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_id</span></font></font>的重要值，栈指针相同就表明可能产生相同的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_id</span></font></font>，这样<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/dummy-frame.c:dummy_frame_sniffer</span></font></font>在搜索<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy_frame_stack</span></font></font>列表的时候，将只能返回相同<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_id</span></font></font>的第一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy
frame</span></font></font>，这样将产生错误。所以这里进行分配空间的操作防止产生相同的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_id</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy
frame</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>没有设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_align</span></font></font>函数指针，后面将直接使用前面取得的当前栈指针，这里有一些注释说没有对齐的栈指针是个很严重的问题，其实也没那么严重，没有设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_align</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>可以在下面调用的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">push_dummy_call</span></font></font>函数指针中来完成对栈指针进行设置的工作，当然设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_align</span></font></font>我觉得是相对来说更清晰一点。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第四步，对第一个参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">function</span></font></font>进行一些分析取得将被调用的地址<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">funaddr</span></font></font>以及这个函数的返回值是否是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">struct</span></font></font>的标志<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">struct_return</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第五步，判断<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CALL_DUMMY_LOCATION</span></font></font>的值进行不同操作，这个宏一般定义为调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中设置的变量<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">call_dummy_location</span></font></font>，这个变量用来定义调用函数将返回的位置，在这个位置将设置断点。有三个位置可以选择，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ON_STACK</span></font></font>，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">AT_ENTRY_POINT</span></font></font>，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">AT_SYMBOL</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ON_STACK</span></font></font>，将返回地址设置在栈上，这里要调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/infcall.c:push_dummy_code</span></font></font>这个函数的作用是在栈中分配给返回地址上的断点需要的空间。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">AT_ENTRY_POINT</span></font></font>，这是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>中使用最多的一种形式，将返回地址设置在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">symfile_objfile-&gt;ei.entry_point</span></font></font>的值对应的地址上。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">AT_SYMBOL</span></font></font>，这个位置好像只有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">MIPS</span></font></font>使用，将返回地址设置在符号<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">__CALL_DUMMY_ADDRESS</span></font></font>的地址上。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第六步，对参数和返回地址进行处理。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第七步，如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>没有设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">push_dummy_call</span></font></font>函数指针，则提示用户当前的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>不支持相关功能，然后退出。调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_push_dummy_call</span></font></font>将当前的栈和寄存器的状态设置到执行完调用函数指令后的状态。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第八步，调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_id_build</span></font></font>取得<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy_id</span></font></font>，这是比将被运行的函数的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>高一级的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ID</span></font></font>。在前面指定好的位置设置断点，这样要被调用的函数在返回后将可以被中断，这样<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>就能返回正常状态。调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/dummy-frame.c:dummy_frame_push</span></font></font>将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy_id</span></font></font>添加到列表<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy_frame_stack</span></font></font>中<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>这么作的目的在后面介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第九步，作一些初始化的工作，最后调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/infrun.c:proceed</span></font></font>函数，其的作用是在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>中执行被调试程序，其中<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">real_pc</span></font></font>执行的地址就是其开始执行的地址。当这个函数返回的时候就表明对参数中指定的要调用的函数执行完毕。然后调用函数返回最开始存储的当前被调试程序的状态。最后函数返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">8.3.</span></font></font>跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy
frame</span></font></font>相关的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>设置函数</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_unwind_dummy_id (struct gdbarch *gdbarch,
gdbarch_unwind_dummy_id_ftype *unwind_dummy_id)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_unwind_dummy_id_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册函数的编写方法一般是用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_id_build</span></font></font>函数取得当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_id</span></font></font>，一般来说调用其使用的的第一个参数是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">next_frame</span></font></font>存储的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SP</span></font></font>寄存器，第二个参数是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">next_frame</span></font></font>存储的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>寄存器，这两个值需要用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind_register_unsigned</span></font></font>或者<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_pc_unwind</span></font></font>等来取得。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在前面提到过的函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy_frame_sniffer</span></font></font>中，将调用注册的这个函数。函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy_frame_sniffer</span></font></font>的大概被调用过程是这样：包含<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy_frame_sniffer</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy_frame_unwinder</span></font></font>已经被<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind_init</span></font></font>注册在表<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind_data</span></font></font>上。而<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind_init</span></font></font>被<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">_initialize_frame_unwind</span></font></font>调用。所以在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>每次调用前面提到过的函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind_find_by_frame</span></font></font>来取得某<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构的时候，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy_frame_unwinder</span></font></font>结构都被第一个被比较，则函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy_frame_sniffer</span></font></font>第一个被调用。</p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数检查当前要取得的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>是不是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy
frame</span></font></font>。在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy_frame_sniffer</span></font></font>函数中，先通过调用注册的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">unwind_dummy_id</span></font></font>函数指针来取得当前的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_id</span></font></font>，然后跟用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy_frame_push</span></font></font>存到列表<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy_frame_stack</span></font></font>中的每个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy_id</span></font></font>进行比较，如果相同则<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind_find_by_frame</span></font></font>将返回<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy_frame_unwinder</span></font></font>。这么作的目的是因为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy
frame</span></font></font>需要自己特殊的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构才能正常使用。</p>
<p style="margin-bottom: 0cm; line-height: 100%">由上面对调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">unwind_dummy_id</span></font></font>函数指针的过程也可以注意到，不管当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>是否需要在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>中支持<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy
frame</span></font></font>也就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">call</span></font></font>命令，都必须用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">set_gdbarch_unwind_dummy_id</span></font></font>注册<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">unwind_dummy_id</span></font></font>函数，否则<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>将不能运行。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_frame_align (struct gdbarch *gdbarch,
gdbarch_frame_align_ftype *frame_align)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_frame_align_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的这个函数的作用在前面介绍过，其作用对参数指定的地址进行对齐操作。</p>
<p style="margin-bottom: 0cm; line-height: 100%">如果当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>不支持<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy
frame</span></font></font>或者栈指针通过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">set_gdbarch_push_dummy_call</span></font></font>注册的函数来保证对齐，而且这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>在调用函数的时候不会出现相同的栈指针，还不支持<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">red
zone</span></font></font>，则可以不设置这个函数。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_frame_red_zone_size (struct gdbarch *gdbarch, int
frame_red_zone_size)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置变量<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_red_zone_size</span></font></font>到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">FRAME_RED_ZONE_SIZE</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">如果当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>支持<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">red
zone</span></font></font>，则需要设置这个变量。不支持可以设置为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_call_dummy_location (struct gdbarch *gdbarch, int
call_dummy_location)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置变量<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">call_dummy_location</span></font></font>到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中，调用其的宏是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CALL_DUMMY_LOCATION</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">当<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>支持<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy
frame</span></font></font>的时候，需要设置这个变量来确定调用函数将返回的位置，具体设置什么值前面已经介绍过了，一般情况设置为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">AT_SYMBOL</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_push_dummy_code (struct gdbarch *gdbarch,
gdbarch_push_dummy_code_ftype *push_dummy_code)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_push_dummy_code_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中。</p>
<p style="margin-bottom: 0cm; line-height: 100%">当上面的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">call_dummy_location</span></font></font>设置为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ON_STACK</span></font></font>的时候，需要调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">push_dummy_code</span></font></font>这个函数在栈中分配给返回地址上的断点需要的空间，如果设置了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">push_dummy_code</span></font></font>则会调用这个函数，如果没设置则会调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/infcall.c:generic_push_dummy_code</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">从上面的分析可以看出这个函数只有在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">call_dummy_location</span></font></font>设置为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ON_STACK</span></font></font>会被调用，而且如果需要进行的处理比较普通，可以不设置，直接让<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">generic_push_dummy_code</span></font></font>函数。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
set_gdbarch_push_dummy_call (struct gdbarch *gdbarch,
gdbarch_push_dummy_call_ftype *push_dummy_call)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">设置一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_push_dummy_call_ftype</span></font></font>类型的函数指针到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>中。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注册的这个函数的作用是将当前的栈和寄存器的状态设置到执行完调用函数指令后的状态，这样在调用完这个函数后，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>可以直接从被调用函数的第一条指令开始执行。</p>
<p style="margin-bottom: 0cm; line-height: 100%">参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">function</span></font></font>是要调用的函数的描述结构。参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regcache</span></font></font>是当前的寄存器，可以通过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regcache_cooked_write_unsigned</span></font></font>等函数设置寄存器。参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">bp_addr</span></font></font>是被调用函数返回的地址。参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">nargs</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">args</span></font></font>是函数的参数数量和值。参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">struct_return</span></font></font>如果为真则表明返回值是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">struct</span></font></font>类型，则参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">struct_addr</span></font></font>就是用来返回返回值的地址。</p>
<p style="margin-bottom: 0cm; line-height: 100%">一般情况下会将返回地址<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">bp_addr</span></font></font>设置在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">RA</span></font></font>寄存器<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(risc</span></font></font>寄存器常见<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>或者压入栈中<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>例如<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">x86)</span></font></font>；然后检查参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">struct_return</span></font></font>是否为真，如果为真则将参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">struct_addr</span></font></font>存入函数的一个位置中，有时候是作为函数的第一个参数；最后依次存储参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">nargs</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">args</span></font></font>中指定的每个参数到寄存器或者栈中。总体来说这个函数的编写跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>相关的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ABI</span></font></font>的具体实现关系密切。</p>
<p style="margin-bottom: 0cm; line-height: 100%">如果不设置这个函数指针，则<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>不能够支持<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">dummy
frame</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">9.sigtramp
frame</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">9.1.</span></font></font>概述</p>
<p style="margin-bottom: 0cm; line-height: 100%">在某些系统中程序注册的信号处理函数返回的时候会返回到一个称为信号跳板<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(signal
trampoline)</span></font></font>的代码，因为在调试信号处理函数的时候，会需要对这部分代码进行<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>分析，而且这部分代码结构又比较特殊，所以有了单独的类型为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SIGTRAMP_FRAME</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sigtramp
frame</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>中根据确定判断当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>是否在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">signal
trampoline</span></font></font>中的方法使用了两种不同的分析方法，这两种分析方法将在下面进行详细的介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">9.2.</span></font></font>普通分析法</p>
<p style="margin-bottom: 0cm; line-height: 100%">在大部分<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>中，有比较明确的方式根据当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>确定当前是否在信号跳板中，比如通过已知的信号跳板代码范围，或者是解析出相应函数名称来确定当前在信号跳板中，这种情况的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>使用了跟一般<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>一样的分析方式，这种方式在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>中比较常用。</p>
<p style="margin-bottom: 0cm; line-height: 100%">下面介绍一下编写方法：在初始化函数中，象注册普通<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sniffer</span></font></font>函数一样，用前面介绍过的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind_append_sniffer</span></font></font>函数注册一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sniffer</span></font></font>函数。在这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sniffer</span></font></font>函数会根据已知方式判断取得的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>是否是在信号跳板代码中，如果是则返回一个相应的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">struct
frame_unwind</span></font></font>结构，如果不是则返回<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">NULL</span></font></font>。关于这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构前面也介绍过，跟上面介绍不同的是，这里的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">type</span></font></font>要设置为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SIGTRAMP_FRAME</span></font></font>。后面两个分析函数的编写跟普通分析函数编写都一样，也需要通过取得存储寄存器的栈的地址，进而取得寄存器的信息。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">9.3.tramp_frame_prepend_unwinder</span></font></font>法</p>
<p style="margin-bottom: 0cm; line-height: 100%">另一些<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>没有明确的用来确定当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>是否在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sigtramp
frame</span></font></font>的方法，只能通过分析代码的方法，因为其注册分析结构<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">struct
tramp_frame</span></font></font>使用了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp-frame.c:tramp_frame_prepend_unwinder</span></font></font>函数，所以称为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp_frame_prepend_unwinder</span></font></font>方法。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">9.3.1.void
tramp_frame_prepend_unwinder (struct gdbarch *gdbarch, const struct
tramp_frame *tramp_frame)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数中首先做的就是分配一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构的空间，然后将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp_frame</span></font></font>结构以及其他几个变量和函数注册在上面，然后调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame-unwind.c:frame_unwind_prepend_unwinder</span></font></font>将设置好的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构注册到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>列表中。</p>
<p style="margin-bottom: 0cm; line-height: 100%">这里使用的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind_prepend_unwinder</span></font></font>函数跟介绍过的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind_append_sniffer</span></font></font>函数功能是基本一样的，只不过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind_prepend_unwinder</span></font></font>函数是将参数中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构经过处理加到列表最前面，而<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind_append_sniffer</span></font></font>是将参数中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sniffer</span></font></font>函数经过处理加到列表中最后面。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind_prepend_unwinder</span></font></font>函数只被<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp_frame_prepend_unwinder</span></font></font>函数调用。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">9.3.2.struct
tramp_frame</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个结构定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp-frame.h</span></font></font>中，下面对其中元素进行介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">enum
frame_type frame_type;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>的类型。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">int
insn_size;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的指令字节长度。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">struct</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">{</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">  <font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ULONGEST
bytes;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">  <font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ULONGEST
mask;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">}
insn[8];</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个结构在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp-frame.c:tramp_frame_sniffer</span></font></font>函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>这个函数将在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">9.3.3</span></font></font>中介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>中使用，这其中存储了用来跟取得的指令进行比较的指令序列，最后一个的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">bytes</span></font></font>一定是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TRAMP_SENTINEL_INSN</span></font></font>，这个不参与比较，而是表示指令序列结束，具体的使用方法将在介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp_frame_sniffer</span></font></font>函数的时候进行详细的介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
(*init) (const struct tramp_frame *self, struct frame_info
*next_frame, struct trad_frame_cache *this_cache, CORE_ADDR func);</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数指针在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp-frame.c:tramp_frame_cache</span></font></font>函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>这个函数将在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">9.3.4</span></font></font>中介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>中使用，这个函数指针的作用就是分析存储的寄存器的信息，将这些信息设置到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trad_frame_cache</span></font></font>结构上，具体这个函数指针对应函数的编写方法将在介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp_frame_cache</span></font></font>函数的时候进行介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">9.3.3.static
int tramp_frame_sniffer (const struct frame_unwind *self, struct
frame_info *next_frame, void **this_cache)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数就是前面<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp_frame_prepend_unwinder</span></font></font>函数中介绍的注册到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>结构上的函数中的一个，其将在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind_find_by_frame</span></font></font>被调用，用来判断当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame</span></font></font>是否是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sigtramp
frame</span></font></font>。其主要过程是先通过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">next_frame</span></font></font>取得当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>，然后进行一些基本检查，最后调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp_frame_start</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp_frame_start</span></font></font>用代码和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">insn</span></font></font>中存储指令序列进行多次比较，代码的开始地址是从当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>减去<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_type</span></font></font>中<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">insn</span></font></font>实际指令序列的长度<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>不包括<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TRAMP_SENTINEL_INSN)</span></font></font>。每次比较都是从指令列表的第一个地址一直比较到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TRAMP_SENTINEL_INSN</span></font></font>之前的指令，比较方法是将取得的实际指令跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">insn</span></font></font>中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">mask</span></font></font>进行与操作，然后跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">bytes</span></font></font>中进行比较<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>这样每个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">insn</span></font></font>中的元素可以匹配一系列的指令<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>，如果相同就继续比较下一个，如果全相同就标明当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>就在信号跳板中，比较的开始地址就是信号跳板起始地址，将这个地址返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">9.3.4.static
struct trad_frame_cache *tramp_frame_cache (struct frame_info
*next_frame, void **this_cache)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数被<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp-frame.c:tramp_frame_this_id</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp-frame.c:tramp_frame_prev_register</span></font></font>两个函数调用，这两个函数都是在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp_frame_prepend_unwinder</span></font></font>注册到新分配的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_unwind</span></font></font>上。跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.9</span></font></font>介绍的初始化<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">this_cache</span></font></font>的函数一样，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp_frame_cache</span></font></font>也是起同样作用的。</p>
<p style="margin-bottom: 0cm; line-height: 100%">这里的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">this_cache</span></font></font>实际使用的结构是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp-frame.c:tramp_frame_cache</span></font></font>，这个结构中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">func</span></font></font>就是前面<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp_frame_sniffer</span></font></font>取得的信号跳板起始地址，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp_frame</span></font></font>就是最开始注册的结构，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trad_cache</span></font></font>结构是实际上存储寄存器分析结果的位置。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在函数中首先给<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trad_cache</span></font></font>分配空间，然后对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp_frame</span></font></font>中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">init</span></font></font>函数指针进行调用。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">init</span></font></font>函数指针上注册的函数一般都是先根据<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">func</span></font></font>取得存储寄存器信息的地址<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>具体位置的要根据<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>的情况<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>，然后用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trad-frame.c:trad_frame_set_reg_addr</span></font></font>将每个寄存器的地址存到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trad_frame_cache</span></font></font>结构中，最后用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trad-frame.c:trad_frame_set_id</span></font></font>将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_id</span></font></font>存到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trad_frame_cache</span></font></font>结构中。<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_id</span></font></font>用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_id_build</span></font></font>取得，一般来说<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">frame_id_build</span></font></font>的第一个参数栈地址用分析得到的存储寄存器的开始地址，第二个参数用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">func</span></font></font>。然后函数返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%">这些存到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">trad_frame_cache</span></font></font>结构中的值最后会被<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp_frame_this_id</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tramp_frame_prev_register</span></font></font>两个函数使用。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
</body>
</html>