<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<title></title>
	<meta name="generator" content="LibreOffice 4.2.8.2 (Linux)">
	<meta name="author" content="teawater">
	<meta name="created" content="20160920;135431513526295">
	<meta name="changedby" content="teawater">
	<meta name="changed" content="20160920;135518667605229">
	<style type="text/css">
	<!--
		@page { margin: 2cm }
		p { margin-bottom: 0.25cm; line-height: 120% }
	-->
	</style>
</head>
<body lang="zh-CN" dir="ltr">
<p style="margin-bottom: 0cm; line-height: 100%">移植<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB(2)
native v0.1</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">teawater&lt;teawater@gmail.com&gt;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">修改记录：</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">v0.1</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-02-25</span></font></font>，修改了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1</span></font></font>章中的一些错误。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">v0.0</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-02-21</span></font></font>，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">v0.0</span></font></font>版本编写完成。</p>
<p style="margin-bottom: 0cm; line-height: 100%">                   
没有详细介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/solib.c</span></font></font>上动态链接库支持的扩展。</p>
<p style="margin-bottom: 0cm; line-height: 100%">       
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2006-02-02</span></font></font>，文档创建。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">目录</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1.</span></font></font>写在前面</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2.long
ptrace(enum __ptrace_request request, pid_t pid, void *addr, void
*data)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.struct
user</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">4.GDB/gdb/config/ARCH/TARGET.mh</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5.GDB/gdb/config/ARCH/nm-TARGET.h</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">6.GDB/gdb/ARCH-NAT.c
</span></font></font>和 <font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/ARCH-TARGET-NAT.c</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">6.1.</span></font></font>概述</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">6.2.</span></font></font>跟寄存器读取有关的函数</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">6.3.gregset</span></font></font>相关函数</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.</span></font></font>本地<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件支持</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.1.</span></font></font>概述</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.2.struct
core_fns</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.3.GDB</span></font></font>分析<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件的过程</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.4.</span></font></font>让<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>支持<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件分析的方法</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">8.</span></font></font>动态连接库支持</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1.</span></font></font>写在前面</p>
<p style="margin-bottom: 0cm; line-height: 100%">本文针对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB-6.3</span></font></font>进行编写。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">native</span></font></font>表示对某个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>在某个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OS</span></font></font>上<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>称为一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET)</span></font></font>调试的支持，当然要让<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>支持本地调试首先要让<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>支持这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>，这个可以参见“移植<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB(1)”</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>对被调试程序的调试主要是通过调用当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>提供的调试接口<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(ptrace</span></font></font>、<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">procfs</span></font></font>等，后面将详细介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>对被调试程序进行控制，同时取得这个程序的寄存器和内存的信息，所以这个调试接口相关的代码就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">native</span></font></font>代码中比较重要的部分。一般来说不同<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>在同一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OS</span></font></font>会使用同一个调试接口，只是其中略有不同，所以移植一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>已经支持的一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OS</span></font></font>中的时候，只需要根据这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的情况进行一些编码就可以。而关于调试接口的编写将在“移植<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB(3)”</span></font></font>中进行介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在“<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDBINT
11. Native Debugging”</span></font></font>中，是对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">native</span></font></font>的介绍，本文的部分内容也将取自其中。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">下面是本文将使用的缩写：</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDBINT
       GDB Internals Manual</span></font></font>的缩写。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB
          </span></font></font>指<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>源文件目录。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH
         </span></font></font>体系结构名称。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET
       </span></font></font>体系结构下的调试目标，一般是一种操作系统，比如<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2.long
ptrace(enum __ptrace_request request, pid_t pid, void *addr, void
*data)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ptrace</span></font></font>是一个系统调用，其作用是让一个进程观测和控制另一个进程的执行，因为后面有不少跟其相关的内容，所以先在这里对其进行介绍。注意不同的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OS</span></font></font>下<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ptrace</span></font></font>的参数等可能略有不同，这里只是简单介绍，具体情况要以实际<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OS</span></font></font>为准。</p>
<p style="margin-bottom: 0cm; line-height: 100%">不同的参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">request</span></font></font>值表示不同的控制功能，参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">pid</span></font></font>是被控制进程的进程<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ID</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ptrace</span></font></font>的请求和功能说明如下：</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PTRACE_TRACEME</span></font></font>，被控制进程向控制进程发出跟踪请求。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PTRACE_PEEKTEXT</span></font></font>，读取被控制进程代码段的一个字，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>给出地址。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PTRACE_PEEKDATA</span></font></font>，读取被控制进程数据段的一个字，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>给出地址。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PTRACE_PEEKUSR</span></font></font>，读取被控制进程<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">user</span></font></font>结构中的一个字，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>给出地址。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PTRACE_POKETEXT</span></font></font>，向被控制进程代码段写入一个字，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>给出地址，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">data</span></font></font>给出数据。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PTRACE_POKEDATA</span></font></font>，向被控制进程数据段写入一个字，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>给出地址，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">data</span></font></font>给出数据。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PTRACE_POKEUSR</span></font></font>，向被控制进程<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">user</span></font></font>结构写入一个字，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>给出地址，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">data</span></font></font>给出数据。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PTRACE_CONT</span></font></font>，如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">data</span></font></font>参数为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">non-zero</span></font></font>并且不是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SIGSTOP</span></font></font>时，它被解释成一个信号传递给被控制进程，否则<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">,</span></font></font>无信号被传递。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PTRACE_KILL</span></font></font>，向被控制进程发送<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SIGKILL</span></font></font>信号来终止其。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PTRACE_SINGLESTEP</span></font></font>，使被控制进程单步执行。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.struct
user</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个结构在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux</span></font></font>中被定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux
Kernel</span></font></font>目录<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">include/asm-ARCH/user.h</span></font></font>中，因为其中记录了寄存器等跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OS</span></font></font>相关的信息，所以不同的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OS</span></font></font>是不同的。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">在某些<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OS</span></font></font>比如<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux</span></font></font>的很多<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ptrace</span></font></font>实现中，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PTRACE_PEEKUSR</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PTRACE_POKEUSR</span></font></font>都只对寄存器相关的参数读写起作用，其他部分根本不进行实际的操作，所以实际对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">user</span></font></font>结构的使用要视实际情况来做。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">4.GDB/gdb/config/ARCH/TARGET.mh</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个文件是设置一些编译<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>需要的跟当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>有关的文件。下面介绍一下其中可设置的信息。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">NAT_FILE=</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个是指定描述<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>的头文件，一般来说这个头文件的写法为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">nm-TARGET.h</span></font></font>存放在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/config/ARCH/</span></font></font>目录中，具体内容将在后面介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">NATDEPFILES=</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个是指定要编译的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.o</span></font></font>文件，后面将介绍的跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>有关的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.c</span></font></font>文件编译成的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.o</span></font></font>文件需要在这里指出。这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>需要的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH-TARGET-NAT.o</span></font></font>文件也需要在这里指定，有些<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>会有一个通用的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH-NAT.o</span></font></font>文件也在这里指定。</p>
<p style="margin-bottom: 0cm; line-height: 100%">下面介绍一下常见的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.o</span></font></font>文件：</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">inftarg.o</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个文件中包含了通过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ptrace</span></font></font>对被调试程序进行控制的调试接口。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">procfs.o</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个文件中包含了通过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">/proc</span></font></font>对被调试程序进行控制的调试接口。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sol-thread.o</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个文件中包含了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Solaris</span></font></font>线程调试接口。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">corelow.o</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个文件包含了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>调试接口，给<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>增加了对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件进行分析的功能。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core-aout.o</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个文件向上面的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">corelow.o</span></font></font>提供了对未知格式的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件的支持。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core-regset.o</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个文件向上面的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">corelow.o</span></font></font>提供了对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">elf</span></font></font>格式同时支持<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regsets</span></font></font>结构的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OS</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件的支持。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">infptrace.o</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个文件中包含了一些使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ptrace</span></font></font>的接口，如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">NATDEPFILES=</span></font></font>包含<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">inftarg.o</span></font></font>则最好包含这个文件。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">fork-child.o</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个文件中包含了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">fork</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">exec</span></font></font>启动被调试程序的接口，一般的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">NATDEPFILES=</span></font></font>都需要包含这个文件。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gcore.o</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">给<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>增加一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gcore</span></font></font>的命令，用来给当前被调试程序产生<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">thread-db.o</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.o</span></font></font>文件包含了对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">target
multi-thread</span></font></font>的支持。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">proc-service.o</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">用来向不支持<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">proc_service</span></font></font>的编译环境提供<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">proc-service</span></font></font>函数，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">thread-db.o</span></font></font>文件需要<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">proc-service</span></font></font>函数。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">linux-nat.o</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.o</span></font></font>文件包含了很多<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux</span></font></font>相关的命令等，建议当<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>所在的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OS</span></font></font>是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux</span></font></font>的时候包含这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.o</span></font></font>文件。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">solib.o</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.o</span></font></font>文件中包含了通用的动态链接库处理函数，具体可见下面对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SOLIB_ADD</span></font></font>等宏的介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">solib-TYPE.o</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">有一系列<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.o</span></font></font>文件，比如<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">solib-svr4.o
solib-aix.o</span></font></font>，他们是向<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">solib.o</span></font></font>提供对某个具体动态库支持的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.o</span></font></font>文件。</p>
<p style="margin-bottom: 0cm; line-height: 100%">这其中跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux</span></font></font>比较密切的有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">solib-svr4.o</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">solib-legacy.o</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">LOADLIBES=</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">指定连接时候需要的库文件，如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OS</span></font></font>是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux</span></font></font>，因为需要在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>启动的时候转载动态链接库<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">libthread_db</span></font></font>，所以通常使用“<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">-ldl
-rdynamic”</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">具体这个文件的编写还可以参照其他<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.mh</span></font></font>文件。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5.GDB/gdb/config/ARCH/nm-TARGET.h</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个文件是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>的头文件，在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">native</span></font></font>的代码这个文件是比较重要的。</p>
<p style="margin-bottom: 0cm; line-height: 100%">一般来说这个文件都包含一个“<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">config/nm-TARGET.h”</span></font></font>名称的头文件，因为这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OS</span></font></font>在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>中已经支持，比如<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">config/nm-linux.h(</span></font></font>注意：<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OS</span></font></font>名称一样<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>，则可以包含这个头文件来设置一些跟这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OS</span></font></font>相关的选项。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDBINT
11.6</span></font></font>中介绍了头文件中可以设置的宏，下面将对其中一部分进行介绍：</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">FETCH_INFERIOR_REGISTERS</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">定义这个宏表明当前的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>将定义自己的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">fetch_inferior_registers</span></font></font>函数和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">store_inferior_registers</span></font></font>函数。具体这两个函数将在后面进行介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KERNEL_U_SIZE</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">定义<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">user</span></font></font>结构的长度，一般是定义一个函数，然后函数中返回<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sizeof(struct
user)</span></font></font>。比较独特的是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">MIPS</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Nm-linux.h</span></font></font>，直接写了个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">504</span></font></font>，也是其的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sizeof(struct
user)</span></font></font>的长度，注释说这么写的好处是对交叉编译的支持更好，不过我觉得要是头文件都没配置好，再友好后面也要出错吧。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KERNEL_U_ADDR</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">定义<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">user</span></font></font>结构在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Kernel</span></font></font>中的地址。这个宏的作用是这样的，因为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">user</span></font></font>结构中有些指针是指向这个结构中另一个参数，通过取得指针的值然后减去<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KERNEL_U_ADDR</span></font></font>，就可以取得指针指向参数相对于<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">user</span></font></font>结构的偏移，也就可以方便的取得其中的值。</p>
<p style="margin-bottom: 0cm; line-height: 100%">很多系统不需要这个值，可以直接将其设置为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">U_REGS_OFFSET</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">定义<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">user</span></font></font>结构中寄存器信息元素<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>一般命名为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regs)</span></font></font>在整个结构中的偏移，比如很多<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">user</span></font></font>结构中的寄存器信息元素在最开头，这个宏就会定义为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">REGISTER_U_ADDR
(addr, blockend, regno)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个宏的作用是根据从<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">U_REGS_OFFSET</span></font></font>得到的寄存器信息在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">user</span></font></font>结构中的偏移<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">blockend</span></font></font>取得序号为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regno</span></font></font>的寄存器在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">user</span></font></font>结构中的偏移并将其存入<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">这个宏实际只有一个作用，就是如果定义这个宏则在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/core-aout.c</span></font></font>中生成一个函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">register_addr</span></font></font>，所以也可以不在头文件中定义<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">REGISTER_U_ADDR</span></font></font>而直接在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>相关的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.c</span></font></font>文件中编写一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">register_addr</span></font></font>，但是不要<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">REGISTER_U_ADDR</span></font></font>宏和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">register_addr</span></font></font>同时编写。具体<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">register_addr</span></font></font>将在后面进行详细介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%">还要注意如果你的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>编译的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.o</span></font></font>文件中不包含<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core-aout.o</span></font></font>也就是默认生成<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">register_addr</span></font></font>的库文件，则需要在你自己的项目库文件中包含<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">register_addr</span></font></font>，光在头文件中包含<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">REGISTER_U_ADDR</span></font></font>就不行了。同时因为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">register_addr</span></font></font>函数的作用是在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>自带的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">fetch_inferior_registers</span></font></font>函数和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">store_inferior_registers</span></font></font>函数中被调用，也就是没定义<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">FETCH_INFERIOR_REGISTERS</span></font></font>的时候，所以如果当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>定义了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">FETCH_INFERIOR_REGISTERS</span></font></font>，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">REGISTER_U_ADDR</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">register_addr</span></font></font>都不需要被定义。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CHILD_PREPARE_TO_STORE</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个宏会在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ptrace</span></font></font>、<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">procfs</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gnuhurd</span></font></font>调试接口的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">child_prepare_to_store</span></font></font>函数使用，这个函数的作用是在对寄存器进行设置以前，有时候需要先进行一些操作，比如在某些<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>下无法设置一个寄存器，只能设置全部寄存器，则需要将全部寄存器的值读出来，再进行设置，这个操作就将在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">child_prepare_to_store</span></font></font>调用。</p>
<p style="margin-bottom: 0cm; line-height: 100%">当<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>需要这种设置寄存器以前的操作的时候，可以将函数定义为这个宏。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>的现有代码中，只有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/config/nm-gnu.h</span></font></font>中设置了这个宏。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">I386_USE_GENERIC_WATCHPOINTS</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">顾名思义这个宏只有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">I386</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>需要，定义这个宏表明使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/i386-nat.c</span></font></font>中的特定断点功能，我估计其中使用了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">i386</span></font></font>的调试寄存器。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ONE_PROCESS_WRITETEXT</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">定义这个宏表明被调试进程的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TEXT</span></font></font>节只允许一个进程对其写，当设置断点的时候如果发生错误则会返回相应的错误信息。在现有的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>代码中没有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>使用这个宏。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SHELL_COMMAND_CONCAT</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">当<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>运行被调试程序的时候，这个宏将被添加到程序名称的前面，一般来说这个宏不需要设置。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SHELL_FILE</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个宏用来指定<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>运行被调试程序的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SHELL</span></font></font>的目录名，一般不需要设置，使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/fork-child.c</span></font></font>中默认指定的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;/bin/sh&quot;</span></font></font>就可以。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SOLIB_ADD
(filename, from_tty, targ, readsyms)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">增加动态链接库的符号信息到当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>的符号表中，一般情况可以使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/solib.c</span></font></font>中的代码，直接包含<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">solib.h</span></font></font>就可以，注意前面介绍过的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">config/nm-linux.h</span></font></font>包含<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">solib.h</span></font></font>文件。这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/solib.c</span></font></font>中的代码是可以通过向<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">struct
target_so_ops
*current_target_so_ops</span></font></font>中增加结构来扩展支持很多类型的动态库，现在支持的有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">aix</span></font></font>、<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sunos</span></font></font>、<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">svr4</span></font></font>等，关于其扩展的方式将在以后的版本中进行介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SOLIB_CREATE_INFERIOR_HOOK</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个宏将在运行被调试程序后调用，一般运行一些动态连接库重定位相关的代码。跟上面一个宏一样使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/solib.c</span></font></font>中的代码，直接包含<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">solib.h</span></font></font>就可以。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CLEAR_SOLIB</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个宏会在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>清除所有符号的时候调用，用来清除动态链接库的信息。跟上面一个宏一样使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/solib.c</span></font></font>中的代码，直接包含<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">solib.h</span></font></font>就可以。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">START_INFERIOR_TRAPS_EXPECTED</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">当启动被调试程序的时候，一般会有两次<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TRAP(</span></font></font>指被调试程序被断点中断，进入<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">KERNEL)</span></font></font>，第一次是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SHELL</span></font></font>的执行，第二次是被调试程序的执行。如果编写的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>是两次<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TRAP</span></font></font>则不需要进行设置，如果不是可以用这个宏进行指定。</p>
<p style="margin-bottom: 0cm; line-height: 100%">根据现有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>的代码，建议定义这个宏的时候对其先<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">undef</span></font></font>一下。举例：</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">#undef
START_INFERIOR_TRAPS_EXPECTED</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">#define
START_INFERIOR_TRAPS_EXPECTED 4</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DEBUG_PTRACE</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/infptrace.c</span></font></font>文件<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">137</span></font></font>行开始也就是判断是否定义了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DEBUG_PTRACE</span></font></font>开始，使用前面定义的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">call_ptrace</span></font></font>函数来替换<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ptrace</span></font></font>进行调试，这样可以在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">call_ptrace</span></font></font>设置断点方便调试<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PTRACE_TYPE_ARG5</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">判断的位置跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DEBUG_PTRACE</span></font></font>一样，但是目的不同。这个宏用来确定当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ptrace</span></font></font>是否有第<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5</span></font></font>个参数，如果是则使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">call_ptrace</span></font></font>函数替换<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ptrace</span></font></font>进行调试，而在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">call_ptrace</span></font></font>对是否定义了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PTRACE_TYPE_ARG5</span></font></font>进行了检查，保证可以正常编译。</p>
<p style="margin-bottom: 0cm; line-height: 100%">这个宏应该是定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">configure</span></font></font>的时候生成的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/config.h</span></font></font>文件中的，不需要在文件中指定。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PTRACE_ARG3_TYPE</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ptrace</span></font></font>系统调用的第三个参数的类型。如果不设置则会按照<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/inferior.h</span></font></font>文件中的将其定义为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PTRACE_TYPE_ARG3</span></font></font>，而这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PTRACE_TYPE_ARG3</span></font></font>定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">configure</span></font></font>的时候生成的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/config.h</span></font></font>文件中。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PTRACE_XFER_TYPE</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个宏用来标记传输<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ptrace</span></font></font>数据的类型，主要是用来帮助计算数据的长度。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注意这个宏并不是一个通用的宏，只是在部分<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.c</span></font></font>代码中进行了使用，所以如果你没使用可以不进行设置。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">USE_PROC_FS</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">如果定义这个宏则前面介绍过的跟当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>相关的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.o</span></font></font>文件中的进行寄存器信息转换<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(GDB</span></font></font>内部表示方式和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">/proc</span></font></font>表示方式<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>函数进行编译，否则不进行编译。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">HAVE_OPTIONAL_PROC_FS</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">只有少数的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>使用这个宏，这个宏的作用是表明当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>同时支持<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ptrace</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">procfs</span></font></font>两种调试接口，在当前系统有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">/proc</span></font></font>文件系统的时候优先使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">procfs</span></font></font>调试接口。在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/inftarg.c</span></font></font>的初始化函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">_initialize_inftarg</span></font></font>中，就可以看到先会检查系统中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">/proc</span></font></font>文件系统是否正常，如果正常就不初始化<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ptrace</span></font></font>调试接口。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PROC_NAME_FMT</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个宏就是在上面这个宏中介绍的检查代码中使用的，其用来标明当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">/proc</span></font></font>文件系统中下进程文件的名称。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">6.GDB/gdb/ARCH-NAT.c
</span></font></font>和 <font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/ARCH-TARGET-NAT.c</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">6.1.</span></font></font>概述</p>
<p style="margin-bottom: 0cm; line-height: 100%">这两个文件是跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>相关的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">.c</span></font></font>文件，主要包含一些<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>相关的函数。而这个两个函数的关系可以说第一个可以比较方便的应用于同一<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>的多个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>，所以主要是一些<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARCH</span></font></font>相关的函数，当然实际使用的时候可以编写者自己灵活掌握。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">6.2.</span></font></font>跟寄存器读取有关的函数</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CORE_ADDR
register_addr (int regno, CORE_ADDR blockend)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">前面介绍宏<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">REGISTER_U_ADDR</span></font></font>的时候已经介绍过这个函数，这个函数跟宏<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">REGISTER_U_ADDR</span></font></font>的功能一样，根据从<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">U_REGS_OFFSET</span></font></font>得到的寄存器信息在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">user</span></font></font>结构中的偏移<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">blockend</span></font></font>取得序号为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regno</span></font></font>的寄存器在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">user</span></font></font>结构中的偏移并返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%">其他关于这个函数信息可以看上面<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">REGISTER_U_ADDR</span></font></font>的介绍内容。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
fetch_inferior_registers (int regno)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数只有在定义了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">FETCH_INFERIOR_REGISTERS</span></font></font>宏后才能包含在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>自己的库函数里。这个函数的作用是将指定序号<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regno</span></font></font>的寄存器的值通过调试接口比如<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ptrace</span></font></font>从被调试程序中读出，然后调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/regcache.c:regcache_raw_supply</span></font></font>函数将这个寄存器的信息存储到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/regcache.c:current_regcache</span></font></font>中。如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regno</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">-1</span></font></font>则表示要将所有寄存器的信息存储到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/regcache.c:current_regcache</span></font></font>中。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
store_inferior_registers (int regno)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数只有在定义了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">FETCH_INFERIOR_REGISTERS</span></font></font>宏后才能包含在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>自己的库函数里。这个函数的作用从<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/regcache.c:current_regcache</span></font></font>中通过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/regcache.c:regcache_raw_collect</span></font></font>函数读出<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regno</span></font></font>指定的寄存器信息，然后通过调试接口比如<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ptrace</span></font></font>写如被调试程序中。如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regno</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">-1</span></font></font>则表示要将所有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/regcache.c:current_regcache</span></font></font>中的寄存器的信息存储到被调试程序中。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">6.3.gregset</span></font></font>相关函数</p>
<p style="margin-bottom: 0cm; line-height: 100%">下面介绍的四个函数是用来将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>内部使用的格式的寄存器信息和本地<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OS</span></font></font>使用的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gregset</span></font></font>格式的寄存器信息<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux</span></font></font>中被定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">Linux
Kernel</span></font></font>目录<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">include/asm-ARCH/elf.h</span></font></font>中<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>进行相互转化的函数。其中<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdb_gregset_t</span></font></font>存储普通寄存器和控制寄存器信息，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdb_fpregset_t</span></font></font>存储浮点寄存器的信息。注意有这几个函数的时候别忘记包含头文件<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gregset.h</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
fill_gregset (gdb_gregset_t *gregsetp, int regno)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数从<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/regcache.c:current_regcache</span></font></font>中通过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/regcache.c:regcache_raw_collect</span></font></font>函数读出<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regno</span></font></font>指定的寄存器信息，然后转化成<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdb_gregset_t</span></font></font>的格式，存入<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gregsetp</span></font></font>中。如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regno</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">-1</span></font></font>则表示要将所有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/regcache.c:current_regcache</span></font></font>中的寄存器的信息转化存储到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gregsetp</span></font></font>中。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
supply_gregset (gdb_gregset_t *gregsetp)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gregsetp</span></font></font>中的信息先转化成<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>内部使用的寄存器格式，然后调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/regcache.c:regcache_raw_supply</span></font></font>函数这些信息存储到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/regcache.c:current_regcache</span></font></font>的每个寄存器中。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
fill_fpregset (gdb_fpregset_t *fpregsetp, int regno)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数从<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/regcache.c:current_regcache</span></font></font>中通过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/regcache.c:regcache_raw_collect</span></font></font>函数读出<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regno</span></font></font>指定的浮点寄存器信息，然后转化成<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdb_fpregset_t</span></font></font>的格式，存入<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">fpregsetp</span></font></font>中。如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regno</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">-1</span></font></font>则表示要将所有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/regcache.c:current_regcache</span></font></font>中的浮点寄存器的信息转化存储到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">fpregsetp</span></font></font>中。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
supply_fpregset (gdb_fpregset_t *fpregsetp)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">fpregsetp</span></font></font>中的信息先转化成<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>内部使用的浮点寄存器格式，然后调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/regcache.c:regcache_raw_supply</span></font></font>函数这些信息存储到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/regcache.c:current_regcache</span></font></font>的每个浮点寄存器中。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">还有两个函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">supply_fpxregset</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">fill_fpxregset</span></font></font>是用来对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">i386</span></font></font>扩展浮点寄存器<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(SSE)</span></font></font>进行格式转化用的，因为只有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">i386</span></font></font>使用，而且结构比较清晰，所以就不进行介绍了。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.</span></font></font>本地<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件支持</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.1.</span></font></font>概述</p>
<p style="margin-bottom: 0cm; line-height: 100%">前面已经介绍过，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件的支持是通过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">corelow.o</span></font></font>也就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/corelow.c</span></font></font>文件来实现的，其中的调试接口在用户用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">-c</span></font></font>选项或者使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">target
core</span></font></font>命令的方式分析<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件的时候将会被调用，而在调用这些调试接口的时候，将先会进行一些处理，然后对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_file_fns</span></font></font>列表中注册的每个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_fns</span></font></font>结构的进行扫描，选择合适的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_fns</span></font></font>结构，调用其中的函数。也有可能是调用“移植<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB(1)”</span></font></font>中介绍过的用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">set_gdbarch_regset_from_core_section</span></font></font>注册的函数。具体整个过程将在下面进行详细的介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.2.struct
core_fns</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个结构定义在文件<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/gdbcore.h</span></font></font>中，因为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件有不同的类型，所以需要可以根据情况进行扩展，而<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_fns</span></font></font>结构就是其扩展接口。</p>
<p style="margin-bottom: 0cm; line-height: 100%">下面来介绍一下<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_fns</span></font></font>结构中的每个元素：</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">enum
bfd_flavour core_flavour;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个变量表示注册的这组函数关联的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件的类型，在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>中常见的就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">bfd_target_unknown_flavour</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">bfd_target_elf_flavour</span></font></font>，分别代表未知和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">elf</span></font></font>格式。对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_flavour</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件类型进行比较的只有一个函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/corelow.c:default_core_sniffer</span></font></font>，具体使用在介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_sniffer</span></font></font>的时候进行介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">int
(*check_format) (bfd *);</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">并不是每个被指定来的当作<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件分析的文件都是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">BFD</span></font></font>支持的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件，比如一个特殊的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_fns</span></font></font>结构，分析的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件并不符合<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">BFD</span></font></font>结构中<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">bfd_core</span></font></font>格式，为了也能对其进行分析，则需要注册<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">check_format</span></font></font>函数。函数如果确定当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件的格式可以用当前的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_fns</span></font></font>结构分析就非<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，否则返回<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>。如果支持的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">BFD</span></font></font>支持的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">bfd_core</span></font></font>格式，就注册函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/corelow.c:default_check_format</span></font></font>，这个函数不会进行任何判断而直接返回<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">int
(*core_sniffer) (struct core_fns *, bfd *);</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">注册在这个函数指针的函数会根据当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">BFD</span></font></font>格式和当前的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_fns</span></font></font>结构支持的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">BFD</span></font></font>格式，如果相同就返回非<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，不同就返回<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>。一般这个指针注册前面提到的函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/corelow.c:default_core_sniffer</span></font></font>，这个函数结构很简单，取出当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">BFD</span></font></font>格式和当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_fns</span></font></font>结构的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_flavour</span></font></font>结构进行比较，相同就返回真。</p>
<p style="margin-bottom: 0cm; line-height: 100%">注意如果前面的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">check_format</span></font></font>返回了真，则要保证在这里也返回真，否则将影响<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>的运行，后面<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.3</span></font></font>会作详细解释。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">void
(*core_read_registers) (char *core_reg_sect, unsigned core_reg_size,
int which, CORE_ADDR reg_addr);</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">注册在这个指针上的函数用来从<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件内容中将寄存器信息读出然后进行转化用函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regcache_raw_supply</span></font></font>存储到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">current_regcache</span></font></font>中。其参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_reg_sect</span></font></font>是指向<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件中寄存器信息的指针；<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_reg_size</span></font></font>是这些信息的长度；<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">which</span></font></font>是信息的类型，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>是普通寄存器，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2</span></font></font>是浮点寄存器，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3</span></font></font>是前面提过的扩展浮点寄存器；<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">reg_addr</span></font></font>，指从<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">u.u_ar0</span></font></font>到寄存器信息的偏移，用来确定老式的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">section</span></font></font>中的寄存器信息的位置，具体看注释。</p>
<p style="margin-bottom: 0cm; line-height: 100%">一般来说这个函数的编写方式是先根据<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">which</span></font></font>确定<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_reg_sect</span></font></font>中信息的格式是普通类型<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdb_gregset_t</span></font></font>或者浮点类型<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdb_fpregset_t</span></font></font>，然后进行转化然后调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regcache_raw_supply</span></font></font>将每个寄存器的信息写入<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">current_regcache</span></font></font>或者直接调用前面介绍过的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">supply_gregset</span></font></font>进行这个工作。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">struct
core_fns *next;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">指向下一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_fns</span></font></font>结构。将一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_fns</span></font></font>结构加入列表<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_file_fns</span></font></font>使用函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/corelow.c:deprecated_add_core_fns</span></font></font>，这个函数会将每个结构依次用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">next</span></font></font>连起来。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.3.GDB</span></font></font>分析<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件的过程</p>
<p style="margin-bottom: 0cm; line-height: 100%">第一步，当用户用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">-c</span></font></font>选项或者使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">target
core</span></font></font>命令的方式分析<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件的时候，会调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/corelow.c:core_open</span></font></font>函数。经过一些打开等的操作，就会调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/bfd/format.c:bfd_check_format</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/corelow.c:gdb_check_format</span></font></font>，这里的作用就是检查<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件的格式是否正确。前面的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">bfd_check_format</span></font></font>函数是检查当前打开的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件格式是否是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">bfd_core</span></font></font>，而后面的函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdb_check_format</span></font></font>会循环调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_file_fns</span></font></font>列表中每个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_fns</span></font></font>结构的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">check_format</span></font></font>函数指针，只要有一个返回真就返回真，这两个函数如果都返回假则报错退出。这里调用的目的就是判断当前的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件格式是否能被<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB</span></font></font>处理。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第二步，经过一部分的处理，然后调用函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/corelow.c:sniff_core_bfd</span></font></font>。这个函数会先用函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/gdbarch.c:gdbarch_regset_from_core_section_p</span></font></font>检查当前的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_gdbarch</span></font></font>是否支持<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regset_from_core_section</span></font></font>，如果是则直接返回，这么做因为支持<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regset_from_core_section</span></font></font>就可以通过其取得寄存器信息，不需要使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_fns</span></font></font>结构中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_read_registers(</span></font></font>下面介绍到取得寄存器信息的部分中很清晰<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>，所以不需要再执行后面的代码，关于<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regset_from_core_section</span></font></font>的信息可以见“移植<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB(1)5.5”</span></font></font>最后部分的介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%">后面开始的代码就是调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_file_fns</span></font></font>列表中每个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_fns</span></font></font>结构的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_sniffer</span></font></font>函数指针，如果返回真就记录下这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_fns</span></font></font>结构，最后进行检查，如果没有记录到任何<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_fns</span></font></font>结构，就以<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_file_fns</span></font></font>列表中第一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_fns</span></font></font>结构设置进去。</p>
<p style="margin-bottom: 0cm; line-height: 100%">最后<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">sniff_core_bfd</span></font></font>返回，返回值存储在本地全局变量<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_vec</span></font></font>中，后面需要使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_fns</span></font></font>结构的时候，都将直接使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_vec</span></font></font>。这里也说明了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_sniffer</span></font></font>函数指针和设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_vec</span></font></font>的密切关系，所以在前面介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_sniffer</span></font></font>函数指针的时候说前面的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">check_format</span></font></font>返回了真，则要保证在这里也返回真。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第三步，最后经过一系列的处理，调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/target.h:target_fetch_registers</span></font></font>宏，取得全部寄存器的信息，这个宏会调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">current_target.to_fetch_registers</span></font></font>，最终会调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/corelow.c:get_core_registers</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">get_core_registers</span></font></font>函数中，会先检查<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_gdbarch</span></font></font>中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regset_from_core_section</span></font></font>是否设置以及<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_vec</span></font></font>中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_read_registers</span></font></font>是否可用，如果他们都不可用则会报错返回。这里再次说明了这<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2</span></font></font>个指针的存在作用，都是用来从<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件中取得寄存器信息，并且只设置其中一个就可以。</p>
<p style="margin-bottom: 0cm; line-height: 100%">然后是三次调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/corelow.c:get_core_register_section</span></font></font>，这三次调用分别是对普通寄存器，浮点寄存器和扩展浮点寄存器的读取。在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">get_core_register_section</span></font></font>函数中，先根据参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">name</span></font></font>也就是存储了寄存器信息的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">section</span></font></font>的名称取得了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">section</span></font></font>的长度<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">size</span></font></font>和内容<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">contents</span></font></font>。然后检查<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_gdbarch</span></font></font>中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regset_from_core_section</span></font></font>是否设置，如果设置了则调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch_regset_from_core_section</span></font></font>根据<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">name</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">size</span></font></font>取得一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regset</span></font></font>结构，然后调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regset</span></font></font>结构中的函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">supply_regset</span></font></font>设置寄存器的信息，在“移植<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB(1)5.5”</span></font></font>中已经介绍过这些函数等，所以这里不作详细介绍。最后调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_vec-&gt;core_read_registers</span></font></font>读取寄存器信息。函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">get_core_register_section</span></font></font>返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">get_core_registers</span></font></font>最后调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/regcache.c:deprecated_registers_fetched</span></font></font>函数，标记全部寄存器已经都被从被调试程序取出值了。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">7.4.</span></font></font>让<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>支持<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件分析的方法</p>
<p style="margin-bottom: 0cm; line-height: 100%">通过前面的介绍，可以知道如果想在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>中支持<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件的分析，可以使用两种方式：第一种是给<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">set_gdbarch_regset_from_core_section</span></font></font>设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">regset_from_core_section</span></font></font>；第二种是用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">deprecated_add_core_fns</span></font></font>向列表<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_file_fns</span></font></font>设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_fns</span></font></font>结构。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第一种方式需要在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gdbarch</span></font></font>的代码中进行设置，其不能方便的支持多种<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件结构，而且如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core</span></font></font>文件不是标准的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">BFD</span></font></font>的结构<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">bfd_core</span></font></font>也不能用这种方式支持。</p>
<p style="margin-bottom: 0cm; line-height: 100%">第二种方式可以在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TARGET</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/ARCH-TARGET-NAT.c</span></font></font>文件中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">_initialize_</span></font></font>名称类型的初始化函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>这个函数的初始化原理将在“移植<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB(3)”</span></font></font>中进行介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>中用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">deprecated_add_core_fns</span></font></font>向列表<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_file_fns</span></font></font>设置自己定义的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_fns</span></font></font>结构；也可以在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GDB/gdb/config/ARCH/TARGET.mh</span></font></font>中定义前面介绍过的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core-aout.o</span></font></font>文件和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core-regset.o</span></font></font>文件，这两个文件关联的格式分别是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">bfd_target_unknown_flavour</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">bfd_target_elf_flavour</span></font></font>。实际的使用中这两种设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">core_fns</span></font></font>结构的方式可以根据需要混合使用。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">8.</span></font></font>动态连接库支持</p>
<p style="margin-bottom: 0cm; line-height: 100%">主要的支持方式可以见前面<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SOLIB_ADD</span></font></font>、<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SOLIB_CREATE_INFERIOR_HOOK</span></font></font>、<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CLEAR_SOLIB</span></font></font>几个宏的介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
</body>
</html>