<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<title></title>
	<meta name="generator" content="LibreOffice 4.2.8.2 (Linux)">
	<meta name="author" content="teawater">
	<meta name="created" content="20160920;110706941578442">
	<meta name="changedby" content="teawater">
	<meta name="changed" content="20160920;110755623648790">
	<style type="text/css">
	<!--
		@page { margin: 2cm }
		p { margin-bottom: 0.25cm; line-height: 120% }
	-->
	</style>
</head>
<body lang="zh-CN" dir="ltr">
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SKYEYE</span></font></font>指令动态翻译模拟讲座提纲</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">teawater(teawater@gmail.com)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1.</span></font></font>说在前面</p>
<p style="margin-bottom: 0cm; line-height: 100%">如果大家有什么问题或者觉得我说的有什么错误可以直接打断我。</p>
<p style="margin-bottom: 0cm; line-height: 100%">下面为了方便，直接称呼指令动态翻译模拟为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>很多模拟思想是取自<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">QEMU</span></font></font>的，但是在某些地方也有不同，我会在后面向大家介绍，建议有兴趣的可以读读<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">QEMU</span></font></font>的代码。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2.</span></font></font>基本介绍</p>
<p style="margin-bottom: 0cm; line-height: 100%">这里注意一边画图一边讲</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>就是将若干条连续的被模拟指令组成一组<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>称为一个翻译块<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB)</span></font></font>，将每条指令根据其行为直接翻译成若干条微指令<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>这里跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">QEMU</span></font></font>不同，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">QEMU</span></font></font>在翻译过程中有中间码存在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>，每条微指令代表一种操作行为并由若干条本地指令组成，最后就得到一组跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>对应的本地指令，再在结尾增加返回指令，对这组指令开始的地址进行函数调用，就达到了指令模拟的目的。</p>
<p style="margin-bottom: 0cm; line-height: 100%">因为每条被模拟指令都有若干行为
所以将他们分为微指令 方便翻译工作 让翻译工作更透明</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">其他我所了解指令模拟方式还有最常见的直接读入一条指令<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>模拟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CPU</span></font></font>行为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>，然后对指令进行解码分析，根据需要进行其操作，然后再读入下一条指令，重复刚才的工作，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SKYEYE</span></font></font>普通指令模拟方式就是这种类型。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">还有一种模拟方式是将要模拟的硬件行为翻译成某种语言比如<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">C</span></font></font>语言的函数等，然后编译执行来进行指令模拟。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.</span></font></font>微指令</p>
<p style="margin-bottom: 0cm; line-height: 100%">微指令是从<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">QEMU</span></font></font>中最主要得到的思想
在结构上和使用上都比较类似</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.1.</span></font></font>微指令的结构和初始化</p>
<p style="margin-bottom: 0cm; line-height: 100%">在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>代码中，每条微指令都被封装在定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">arm2x86.h</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">op_table_t</span></font></font>结构中，这个结构中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">op</span></font></font>是指向这个微指令的地址，而<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">len</span></font></font>则是这个微指令的长度。每条微指令的的初始化都是由一个名称为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">get_op_xxx</span></font></font>形式的函数来完成的，这个函数会将微指令的地址返回，用来设置在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">op</span></font></font>中，而其的参数指针是用来设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">len</span></font></font>的，这些函数都会在微指令初始化函数中被调用。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在这个函数中有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2</span></font></font>个定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">arm2x86.h</span></font></font>中的宏<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OP_BEGIN</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OP_END</span></font></font>，这<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2</span></font></font>个宏都是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">X86</span></font></font>指令。在这<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2</span></font></font>个宏之间的代码就是微指令的代码。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">#define
OP_BEGIN(f)		__asm__ __volatile__ (&quot;jmp
.&quot;f&quot;_teawater_op_end\n\t&quot;&quot;.&quot;f&quot;_teawater_op_begin:\n\t&quot;)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">#define
OP_END(f)		__asm__ __volatile__ (&quot;.&quot;f&quot;_teawater_op_end:\n\t&quot;&quot;movl
$.&quot;f&quot;_teawater_op_begin,%0\n\t&quot;&quot;movl
$.&quot;f&quot;_teawater_op_end,%1\n\t&quot;:&quot;=g&quot;(begin),
&quot;=g&quot;(end));</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OP_BEGIN</span></font></font>先是一条跳转指令，跳转到声明在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OP_END</span></font></font>中的符号地址<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">&quot;.&quot;f&quot;_teawater_op_end</span></font></font>，这句的作用是跳过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OP_BEGIN</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OP_END</span></font></font>中间的代码，防止他们被执行，我为什么没有直接使用普通的跳转语句<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">goto</span></font></font>呢？因为如果使用了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">goto</span></font></font>语句，编译器就会知道微指令的代码没被执行，就会将这部分代码优化掉，而使用跳转指令编译器无法判断汇编语句的行为，所以不会优化掉<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2</span></font></font>个宏之间的微指令代码。然后是一条声明符号的伪指令，这个符号指向的地址就是微指令开始的地址。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OP_END</span></font></font>先是一条声明符号的伪指令，这个符号的地址就是指向微指令结束的地址，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">OP_BEGIN</span></font></font>中的跳转指令也是跳到了这个地址。然后跟着是两条赋值指令，将微指令开始和结束的地址存到初始化函数开始声明的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">begin</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">end</span></font></font>变量中，这样在函数中就取得微指令的开始和结束地址。</p>
<p style="margin-bottom: 0cm; line-height: 100%">从上面对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2</span></font></font>个宏的的介绍就可以基本清楚微指令的生成过程，在取得了微指令的开始和接受地址后，就可以通过计算取得其的长度最后返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%">这也是为了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">-O2</span></font></font>以及编译器换了可能影响<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">QEMU</span></font></font>的编译和执行。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">QEMU</span></font></font>的微指令的生成过程跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>不同，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">QEMU</span></font></font>采用的方式是每个微指令都在一个函数中，编译完成后，通过特定的程序将微指令的开始地址和长度取出。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">先讲一下实现微指令本身实现遇见的问题的解决</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.2.</span></font></font>微指令中的变量</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">register
ARMul_State *st asm (AREG_st);</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">//register
struct ARMul_State *st       asm(AREG_st);</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">register
uint32_t T0 asm (AREG_T0);</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">register
uint32_t T1 asm (AREG_T1);</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">register
uint32_t T2 asm (AREG_T2);</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">volatile</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">T0
T1 T2</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">在微指令的代码中，都没有使用动态局部变量，也就是栈中的地址，而直接使用了寄存器<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(T1
T2 T3)</span></font></font>，当然在寄存器不够的情况下也使用了全局变量。这个使用的方法是参考的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">QEMU</span></font></font>中微指令对变量的使用方法。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">个人认为这样作因为若干条微指令才能组成一条指令<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>尤其是在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARM</span></font></font>这种单条指令实现若干功能的体系结构更是如此<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>，这些微指令之间要相互传递计算等得到的值，如果通过栈传递也可以，但是实现相对复杂，而且频繁的内存操作速度也回受到影响。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">对这些寄存器的声明在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">arm2x86_self.h</span></font></font>这个单独的头文件中，因为对寄存器的声明有时候会影响代码编译，所以只在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>相关的文件中包含了这个头文件。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ebp</span></font></font>寄存器声明为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARMul_State</span></font></font>结构的指针<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">st</span></font></font>，其将在微指令的代码开始之前指向<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">state</span></font></font>也就是存储了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SKYEYE</span></font></font>模拟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CPU</span></font></font>所有信息的结构，这样微指令就可以方便的访问这个结构。<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ebx</span></font></font>、<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">esi</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">edi</span></font></font>声明为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">uint32_t</span></font></font>类型的变量<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">T0,T1</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">T2</span></font></font>，这几个变量在微指令中可以灵活使用。注意因为这几个寄存器保存了栈指针等信息，所以在运行微指令以前需要进行保存，具体在介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>运行的时候会进行介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%">其他<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">eax</span></font></font>等寄存器因为是在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">GCC</span></font></font>中是局部寄存器，不能作为全局变量声明，所以不能作为微指令中的变量使用。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.3.</span></font></font>微指令中的函数调用</p>
<p style="margin-bottom: 0cm; line-height: 100%">在微指令中有时候需要对函数进行调用，因为微指令使用方法的原因，这里不能进行普通的函数调用，而需要特殊处理。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">arm2x86.c:252</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">uint8_t
*</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">get_op_begin
(int *len)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">{</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	unsigned
int begin = 0, end = 0;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	OP_BEGIN
(&quot;get_op_begin&quot;);</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	//T0
= tea_begin(st);</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	__asm__
__volatile__ (&quot;subl	$0xc, %esp&quot;);</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	__asm__
__volatile__ (&quot;push	%&quot; AREG_st);</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	T2
= (uint32_t) tea_begin;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	__asm__
__volatile__ (&quot;call	*%&quot; AREG_T2);</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	__asm__
__volatile__ (&quot;addl	$0x10, %esp&quot;);</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	__asm__
__volatile__ (&quot;movl	%eax, %&quot; AREG_T0);</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	if
(T0) {</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">		__asm__
__volatile__ (&quot;ret&quot;);</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	}</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	OP_END
(&quot;get_op_begin&quot;);</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	*len
= end - begin;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">	return
((uint8_t *) begin);</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">}</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">下面就以<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">arm2x86.c:get_op_begin</span></font></font>中对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tea_begin</span></font></font>函数的调用为例子进行介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%">这里首先是对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">esp</span></font></font>减<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0xc</span></font></font>也就是在栈中分配<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0xc</span></font></font>的空间，然后将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ebp</span></font></font>也就是指向<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARMul_State</span></font></font>结构的指针<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">push</span></font></font>到栈中，这<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2</span></font></font>条汇编指令是将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">st</span></font></font>作为参数传递给被调用函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tea_begin</span></font></font>，前面在栈中分配<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0xc</span></font></font>的空间是要保证传递参数的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0x10</span></font></font>对齐，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0xc</span></font></font>加<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">32</span></font></font>位的长度就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0x10</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">没有存储使用的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">T0
T1 T2
ebp</span></font></font>、<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ebx</span></font></font>、<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">esi</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">edi</span></font></font>，因为这几个全局寄存器的值是由被调用函数进行保存的，如果调用函数修改了这几个寄存器的值就进行保存，在函数返回时恢复，如果没有就使用就不进行保存和恢复。</p>
<p style="margin-bottom: 0cm; line-height: 100%">然后是将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tea_begin</span></font></font>的地址赋值给<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">T2</span></font></font>，然后再对其进行调用，这样做的目的是进行直接地址调用。因为一般的函数调用都是直接地址调用，所以调用跟当前这个调用指令的地址是相关的，但是微指令会被拷贝到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>上的某地址执行，调用指令的地址发生了变化，所以如果进行相对地址调用，肯定要产生错误，所以这里都使用直接地址调用。在某些函数中为了适应<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CYGWIN</span></font></font>使用函数指针进行调用也是出于同样的目的。</p>
<p style="margin-bottom: 0cm; line-height: 100%">最后是取得返回值，一般一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">32</span></font></font>位数的返回值都是放在寄存器<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">eax</span></font></font>中，如果有需要就将其存入<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">T0</span></font></font>等寄存器变量然后使用。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.4.</span></font></font>微指令中的异常处理</p>
<p style="margin-bottom: 0cm; line-height: 100%">模拟指令一般来说都模拟异常处理，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>也不例外。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>的做法是当有异常处理的时候，设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">st-&gt;trap</span></font></font>或者<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">state-&gt;trap</span></font></font>为异常的类型<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>定义在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">arm2x86.h</span></font></font>，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TRAP_XXX</span></font></font>的都是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>，然后根据情况调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">X86</span></font></font>汇编指令<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ret</span></font></font>返回到正常模式，然后在非<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>运行模式中进行实际的处理。</p>
<p style="margin-bottom: 0cm; line-height: 100%">因为这种处理减少了微指令中实现的难度，所以类似<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TRAP_SETS_R15</span></font></font>、<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TRAP_SET_CPSR</span></font></font>以及<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TRAP_SET_R15</span></font></font>等几个非异常处理也采用了同一种处理方式。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.5.</span></font></font>微指令中的跳转</p>
<p style="margin-bottom: 0cm; line-height: 100%">这里的跳转不是指模拟的被模拟指令的跳转，而是指微指令根据需要跳转指定的长度。比如某条被模拟指令有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">condition</span></font></font>判断，其中就会需要这种跳转，当<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">condition</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PSR</span></font></font>中的值不符合的时候，就需要跳过当前指令被翻译成的微指令代码，这个时候就需要跳转过指令的长度。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>中的做法是先写一条类似<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">__asm__
__volatile__
(&quot;jmp	0xffffffff&quot;);</span></font></font>的指令，一般来说后<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">4</span></font></font>个字节就是跳转长度，在翻译指令的时候将要跳转的长度写入就可以。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在后面介绍指令翻译过程的时候，还会对微指令跳转的使用再作详细介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.6.</span></font></font>微指令分类介绍</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.6.1.</span></font></font>概述</p>
<p style="margin-bottom: 0cm; line-height: 100%">因为规划设计的问题，微指令的分类有点乱，所以就以初始化函数为分类基础进行分类介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.6.2.arm2x86.c:op_init</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这里初始化的最重要的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2</span></font></font>个微指令是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">op_begin</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">op_begin_test_T0</span></font></font>，这<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2</span></font></font>个指令都是在翻译<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARM</span></font></font>指令的时候放在每条指令最开始的部分的。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">op_begin</span></font></font>是被翻译的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARM</span></font></font>指令的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">condition</span></font></font>是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">AL</span></font></font>或者<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">NV</span></font></font>也就是不进行条件判断时候使用的微指令。这里先调用了函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">arm2x86.c:tea_begin</span></font></font>，而这个函数调用了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">arm2x86.c:tea_check_out</span></font></font>，这个函数类似普通指令执行模式中指令开始执行时候作的操作一样，检查是否需要单步返回，检查是否有硬件中断发生进行异常处理，检查当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>是否已经标记为脏<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>如果当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>中执行的微指令写了当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>相关的内存，就会有这样的情况发生，这时返回到普通模式重新执行，就会自动对这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>进行重新翻译<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>，最后一步执行<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">armio.c:io_do_cycle</span></font></font>调用全部虚拟设备执行。<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tea_begin</span></font></font>函数返回以后会判断返回值，如果为真就返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">op_begin_test_T0</span></font></font>是被翻译的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARM</span></font></font>指令需要条件判断时候使用的微指令。在这条指令运行以前，被翻译指令的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">condition</span></font></font>已经被存到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">T0</span></font></font>中，这里首先以<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">st</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">T0</span></font></font>为参数调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">arm2x86.c:tea_begin_test</span></font></font>，这个函数也是调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tea_check_out</span></font></font>检查是否有异常等需要从<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>模式返回普通执行模式，如果没有则调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">arm2x86_psr.h:gen_op_condition</span></font></font>判断当前被翻译指令是否可以执行。<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tea_begin_test</span></font></font>返回后，先判断是否有异常需要返回普通执行模式；然后判断是否这条指令是否因为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">condition</span></font></font>而不被执行，如果是则就执行一条<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">jmp</span></font></font>指令，也就是前面介绍过的微指令跳转。</p>
<p style="margin-bottom: 0cm; line-height: 100%">其他几个微指令比较简单不作详细介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.6.3.arm2x86_test.c:arm2x86_test_init</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这里初始化了几个简单的测试情况然后进行一些处理的微指令。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.6.4.arm2x86_shift.c:arm2x86_shift_init</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这里初始化的是各种移位微指令。</p>
<p style="margin-bottom: 0cm; line-height: 100%">这里移位的长度如果是变量的处理起来比较简单，前面在别的微指令中存到某个寄存器变量，然后在这条微指令中直接操作就可以。</p>
<p style="margin-bottom: 0cm; line-height: 100%">如果移位的长度是立即数，则处理办法有点类似前面的微指令跳转。先用一条类似“<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">T1
= T1 &lt;&lt; 31;”</span></font></font>的语句，这样其最后一个值是一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">8</span></font></font>位的移位长度，然后在实际翻译的过程中替换成实际翻译的立即数就可以了。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.6.5.arm2x86_psr.c:arm2x86_psr_init</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这里初始化的是跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARM</span></font></font>的状态寄存器<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PSR(</span></font></font>包括<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">CPSR</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SPSR)</span></font></font>相关的微指令。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.6.6.arm2x86_movl.c:arm2x86_movl_init</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这里初始化是用来对某模拟寄存器或者某寄存器变量等赋值的微指令。</p>
<p style="margin-bottom: 0cm; line-height: 100%">其中的立即数赋值也比较类似前面的微指令跳转，先用类似“<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">T2
=
ULONG_MAX;”</span></font></font>的语句，这样其最后一个值就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">32</span></font></font>位长度的立即数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ULONG_MAX</span></font></font>，然后在实际翻译的过程中替换成实际翻译的立即数就可以了。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.6.7.arm2x86_mul.c:arm2x86_mul_init</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这里初始化是用来对乘法指令进行模拟的微指令。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.6.8.arm2x86_mem.c:arm2x86_mem_init</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这里初始化是用来对内存操作进行模拟的微指令。</p>
<p style="margin-bottom: 0cm; line-height: 100%">这里对内存的操作采用的办法是调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SKYEYE</span></font></font>原有的内存操作函数，直接取得返回值，然后进行各种操作。这里这么作而不是直接访问相应的内存地址因为有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">MMU</span></font></font>的时候，需要先通过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">MMU</span></font></font>中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TLB</span></font></font>和页表等转换地址，而且还有地址是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">IO</span></font></font>地址，所以直接调用内存操作函数是比较简单的实现方法。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">还有一种思路是在翻译的时候进行设置</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.6.9.arm2x86_dp.c:arm2x86_dp_init</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这里初始化的是对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARM</span></font></font>中<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DP</span></font></font>指令进行模拟的微指令。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.6.10.arm2x86_coproc.c:arm2x86_coproc_init</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这里初始化的是对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARM</span></font></font>中协处理器指令进行模拟的微指令。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">3.6.11.arm2x86_other.c:arm2x86_other_init</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这里对所有其他微指令进行初始化。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">4.</span></font></font>翻译块<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(TB)</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">4.1.</span></font></font>概述</p>
<p style="margin-bottom: 0cm; line-height: 100%">在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>中，将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb.h:TB_LEN</span></font></font>长度的被模拟指令翻译成一系列微指令<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>这一系列微指令的长度最大值为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb.h:TB_INSN_LEN_MAX</span></font></font>，由<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb.c:tb_insn_len_max_init</span></font></font>取得<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>，这一系列微指令<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>存储这些微指令的内存称为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP)</span></font></font>以及地址信息等其他信息封装在一起称为一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>。在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>初始化的时候，会根据配置文件以及实际情况对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>进行初始化，介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_memory_init</span></font></font>的时候会详细进行介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">4.2.tb.h:struct
tb_s</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个结构是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>的核心结构，每个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>块都将对应一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_s</span></font></font>结构。</p>
<p style="margin-bottom: 0cm; line-height: 100%">下面对其的每个成员变量进行介绍：</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">struct
list_head	list;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">当使用第二种方法使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>的时候，这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">list</span></font></font>将所有使用过的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>全部用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb.c:tbp_dynamic_list</span></font></font>以及这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">list</span></font></font>结构组成的链表连接起来，在每次使用某个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>的时候，都将其先从链表中删除，然后连接到链表的最后。当对某地址进行执行，而所有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>都不是这个地址相关的，并且没有未使用过的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>，需要从现有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>中选择一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>使用的时候，就会使用链表第一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>。这样做的好处是，最不常用的已翻译过的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>肯定是在链表第一个，选择其影响会最小，提高了效率。在后面介绍翻译执行的时候会进行更具体的介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">int	ted;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个变量为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>表明这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>中数据是没有翻译过的，为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1</span></font></font>表明其中数据是翻译过的。在需要标记某个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>为脏的时候，就可以通过设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ted</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>来实现。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">uint8_t	*insn_addr[TB_LEN
/ sizeof(uint8_t *)];</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">在翻译过程中，将把每条指令对应的微指令地址都存储到这个数组中，这样在执行已经翻译过的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>的时候，可以直接取得对应地址的微指令地址开始执行。</p>
<p style="margin-bottom: 0cm; line-height: 100%">原来的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>中也采用过不存储微指令地址，在执行的时候再重新翻译取得地址的方法，最多是将取得后的地址存储起来，后来考虑即使将所有地址都存起来也不会使用很多内存，所以就用了所有翻译过的地址都存起来的方法。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">uint8_t	*tbp;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个成员变量指向当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>存储微指令的内存，显然这里指向内存块的大小为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_LEN
/ sizeof (ARMword) * TB_INSN_LEN_MAX</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARMword	addr;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个成员变量是当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>对应的被模拟指令的地址。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARMword	tran_addr;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>翻译过程中，并不是一次将整个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>范围内的被模拟指令都翻译成微指令，而是每次翻译到一个必定发生返回的指令，并且实际要取得的微指令地址<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">(</span></font></font>注意翻译是从<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>开始的地址开始的
<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">)</span></font></font>也已经取得，就不再继续进行翻译，等下次请求一个地址比翻译到的地址大的时候，就继续对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>进行翻译。</p>
<p style="margin-bottom: 0cm; line-height: 100%">这个成员变量<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tran_addr</span></font></font>记录的就是翻译到的指令地址的下一个指令的地址，也就是如果继续翻译的地址。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">uint8_t
*tbp_now;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">在成员变量指向当前可以写入微指令的地址，在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;ted</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>也就是这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>从<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;addr</span></font></font>开始翻译的时候初始化为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;tbp</span></font></font>，每增加一个微指令都顺序增加，并且在向上面<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tran_addr</span></font></font>提到的那种继续翻译的时候，可以继续使用。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARMword	last_addr;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">uint8_t	*last_tbp;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">2</span></font></font>个成员在指令翻译的时候使用。<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">last_addr</span></font></font>存储这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>上次被使用时候的地址，而<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">last_tbp</span></font></font>就是对应的微指令地址。这样如果下次还使用这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>的这个地址<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">last_addr</span></font></font>，就可以快速取得微指令地址<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">last_tbp</span></font></font>，提高执行速度。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARMword	ret_addr;</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tran_addr</span></font></font>的时候，已经提到了只翻译到必定发生返回的指令就不再继续翻译，但是这里还有一种情况需要考虑到，就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>在翻译当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>范围内的被模拟指令跳转的时候，都是将这个跳转指令翻译为微指令跳转指令，而不是通常的设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>寄存器然后返回的
方式，这样的跳转如果是向后跳转，并且超过了翻译结束的地址肯定是不行的。</p>
<p style="margin-bottom: 0cm; line-height: 100%">如何防止提前翻译结束？在翻译开始的时候设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ret_addr</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，一旦有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>内跳转出现，并且这个地址的值比<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ret_addr</span></font></font>大，就设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ret_addr</span></font></font>为这个地址。在翻译完一条指令并确定翻译也许可以结束的时候，对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ret_addr</span></font></font>进行检查，只有在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ret_addr</span></font></font>小于下一条将翻译的指令地址的时候，翻译才结束。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">4.3.TB_TBT_SIZE</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBP_SIZE</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb.c</span></font></font>中有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBT_SIZE</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBP_SIZE</span></font></font>，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>的初始化就要根据其的值来进行，他们的定义为：</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">#define
TB_TBT_SIZE	skyeye_config.tb_tbt_size</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">#define
TB_TBP_SIZE	skyeye_config.tb_tbp_size</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBT_SIZE</span></font></font>是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>中所有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>的条目也就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_t</span></font></font>结构所占空间。如果设置为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>则就在使用的时候分配在被模拟内存结构<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">armmem.h:mem_state_t-&gt;tbt</span></font></font>上，也就是只要运行某块内存，就分配其的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_t</span></font></font>结构。如果设置为非<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>就使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb.c:tbt_table</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb.c:tbt_table_size</span></font></font>的内存进行动态分配。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBP_SIZE</span></font></font>是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>中实际储存微指令的内存所占空间。如果设置为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>则就在使用的时候分配在被模拟内存结构<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">armmem.h:mem_state_t-&gt;tbp</span></font></font>上，也就是只要运行某块内存，就分配其的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp</span></font></font>。如果设置为非<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>会同时标记<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_dynamic</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1</span></font></font>表明是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP</span></font></font>动态分配，并且<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP</span></font></font>所用的内存使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb.c:tbp_begin</span></font></font>、<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb.c:tbp_now</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_now_size</span></font></font>进行动态分配。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">skyeye_config.tb_tbt_size</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">skyeye_config.tb_tbp_size</span></font></font>是从配置文件中读出的值，他们的初始化也就是设置默认值在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">skyeye_options.c:skyeye_option_init</span></font></font>函数中。在这里我们可以看到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">config-&gt;tb_tbt_size</span></font></font>也就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBT_SIZE</span></font></font>初始化为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，因为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_t</span></font></font>结构占用空间不大；<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">config-&gt;tb_tbp_size</span></font></font>也就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBP_SIZE</span></font></font>初始化为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBP_DEFAULT(1024
* 1024 *
64)</span></font></font>，这里没有也初始化因为每条被模拟的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARM</span></font></font>指令都包含若干条微指令，这样跟一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>存储的指令对应的微指令存储空间会比较大，甚至有超过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">32</span></font></font>位寻址空间大小的情况，所以这里一般不设置为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">注意<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBT_SIZE</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBP_SIZE</span></font></font>并不是从配置文件中读出后直接使用，而是在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_memory_init</span></font></font>进行过初始化后才使用，和其相关的几个变量也是在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_memory_init</span></font></font>中进行的初始化。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">4.4.tb.c:tb_memory_init</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数用来对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>进行初始化。下面介绍执行过程：</p>
<p style="margin-bottom: 0cm; line-height: 100%">第一步，先判断<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBT_SIZE</span></font></font>是否为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，如果不为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，就会执行一部分针对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBT_SIZE</span></font></font>的代码。注意这里我犯了一个比较大的错误，其中的结构应该使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_t</span></font></font>，而我这里全部错误的使用了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_cache_t</span></font></font>，而这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_cache_t</span></font></font>也是一个不再需要的东西，早应该从代码中去掉，下面的介绍全都假定成<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_cache_t</span></font></font>已经被换成了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_t</span></font></font>。先对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBT_SIZE</span></font></font>进行基本的处理和检查，然后取得所有被模拟内存一共需要<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_t</span></font></font>所占的空间，其跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBT_SIZE</span></font></font>进行比较。如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBT_SIZE</span></font></font>大于等于这个值，则表明<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>不需要动态分配<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_t</span></font></font>来节省空间，就设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBT_SIZE</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，使用固定分配的形势。如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBT_SIZE</span></font></font>小于这个值，则初始化存储<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_t</span></font></font>的空间<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt_table</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_t</span></font></font>的数量<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt_table_size</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">这样<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBT_SIZE</span></font></font>就初始化完成，同时还对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt_table</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt_table_size</span></font></font>进行了设置。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第二步，如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBP_SIZE</span></font></font>为非<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，则对其进行基本的处理和检查。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第三步，再次判断<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBT_SIZE</span></font></font>是否为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，然后对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBP_SIZE</span></font></font>进行处理。</p>
<p style="margin-bottom: 0cm; line-height: 100%">如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBT_SIZE</span></font></font>不为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，首先取得这个长度的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_t</span></font></font>结构组需要的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp</span></font></font>的长度<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tmp_u64</span></font></font>，跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBP_SIZE</span></font></font>进行比较。如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBP_SIZE</span></font></font>大于<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tmp_u64</span></font></font>或者<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBP_SIZE</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，则<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBP_SIZE</span></font></font>设置为这个值，这么作因为在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBT_SIZE</span></font></font>动态分配后，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>无法对大于其管理范围的微指令内存<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP</span></font></font>进行管理，所以进行这个设置。如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBP_SIZE</span></font></font>小于<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tmp_u64</span></font></font>，则设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb.c:tbp_dynamic</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1</span></font></font>，也就是设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>中<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP</span></font></font>为动态分配。</p>
<p style="margin-bottom: 0cm; line-height: 100%">如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBT_SIZE</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，将判断<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBP_SIZE</span></font></font>是否为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>。如果为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>很显然不需要再作任何初始化工作，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_dynamic</span></font></font>使用默认值<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，全部在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>运行时根据需要分配在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">mem_state_t-&gt;tbt</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">mem_state_t-&gt;tbp</span></font></font>上就可以。如果不为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>则先取得全部被模拟内存需要的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP</span></font></font>的长度<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tmp_u64</span></font></font>，然后跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBP_SIZE</span></font></font>进行比较。如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBP_SIZE</span></font></font>大于等于<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tmp_u64</span></font></font>，则表明<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP</span></font></font>已经不需要动态分配，就设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBP_SIZE</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>。如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBP_SIZE</span></font></font>小于<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tmp_u64</span></font></font>，则表明需要动态分配，设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_dynamic</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">这样<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBP_SIZE</span></font></font>就初始化完成，同时也根据需要对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_dynamic</span></font></font>进行了设置。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第四步，这时<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_TBP_SIZE</span></font></font>的值已经得到了确定，这里就是给<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_begin</span></font></font>分配空间，注意这里用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">mmap</span></font></font>分配内存的时候设置了权限为可运行<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PROT_EXEC</span></font></font>。然后对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_now_size</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_now</span></font></font>也进行了初始化。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">这样用来进行<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP</span></font></font>动态分配的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_begin</span></font></font>、<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_now_size</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_now</span></font></font>进行了初始化。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">总结一下，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>中用来维护<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBT</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP</span></font></font>动态分配的几个变量用的有点繁琐了。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">4.5.tb.c:tb_insn_len_max_init</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数用来对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb.c:tb_insn_len_max</span></font></font>也就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_INSN_LEN_MAX</span></font></font>进行了初始化。</p>
<p style="margin-bottom: 0cm; line-height: 100%">做法是将所有被翻译指令被翻译成的微指令长度都取得，然后进行比较，将最长的设置为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_insn_len_max</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">5.</span></font></font>初始化函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">arm2x86.c:arm2x86_init</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>的初始化函数，其在函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">arminit.c:ARMul_Reset</span></font></font>中被调用。</p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数先会调用前面介绍过的几个微指令初始化函数，然后是函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_insn_len_max_init</span></font></font>，最后是函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_memory_init</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">6.</span></font></font>翻译执行过程</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">6.1.armemu.c:ARMul_Emulate32_dbct</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这是整个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">DBCT</span></font></font>翻译执行的核心函数，类似普通指令执行方式的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARMul_Emulate32</span></font></font>函数，也是在<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">arminit.c:ARMul_DoProg</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">arminit.c:ARMul_DoInstr</span></font></font>被调用。下面介绍执行过程：</p>
<p style="margin-bottom: 0cm; line-height: 100%">第一步，给<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">R15</span></font></font>寄存器也就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>寄存器的值增加一个指令长度<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">INSN_SIZE</span></font></font>，这是因为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARM</span></font></font>的多级流水线<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>寄存器对应用是非透明的，而在这个函数外面的函数都将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">R15</span></font></font>当作当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>值，所以在开始执行前先对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">R15</span></font></font>寄存器进行设置。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第二步，设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">state-&gt;trap</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第三步，调用函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb.c:tb_find</span></font></font>，在这个函数中根据参数提供的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>寄存器值，进行全部的分配<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>以及指令翻译的工作，最后将跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>对应的微指令地址返回。如果返回<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">NULL</span></font></font>则表示执行失败，设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">state-&gt;trap</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TRAP_INSN_ABORT</span></font></font>也就是取指异常，跳转到后面对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">state-&gt;trap</span></font></font>进行处理的部分。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第四步，对将在微指令中作为变量的寄存器进行保存，保存的原因前面介绍过，因为这几个寄存器的值都是被调用函数来保存，所以在这里进行保存。</p>
<p style="margin-bottom: 0cm; line-height: 100%">调用取得的指向微指令内存的指针<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">gen_func</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">返回后恢复几个寄存器的值。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第五步，在介绍微指令的时候，介绍过异常等特殊情况，都是先设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">state-&gt;trap</span></font></font>然后就返回，而这里就是实际对异常等进行处理的地方。这部分代码比较清晰，就是根据<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">state-&gt;trap</span></font></font>进行不同的处理，不作详细介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第六步，判断是否还继续执行，或者函数返回。如果继续执行就返回到第二步。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第七步，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">state-&gt;Reg[15]</span></font></font>减<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">INSN_SIZE</span></font></font>，恢复<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>指向当前程序执行的地址，然后返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">6.2.tb.c:tb_find</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">在这个函数中根据参数提供的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>寄存器值，进行全部的分配<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>以及指令翻译的工作，最后将跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">PC</span></font></font>对应的微指令地址返回。下面介绍执行过程：</p>
<p style="margin-bottom: 0cm; line-height: 100%">第一步，调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">armmmu.c:mmu_v2p_dbct</span></font></font>函数通过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">SKYEYE</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">MMU</span></font></font>功能取得跟执行地址<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ADDR</span></font></font>对应的被模拟物理地址<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>，如果失败则函数出错返回。然后通过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_ALIGN</span></font></font>取得跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB_LEN</span></font></font>长度对齐的地址<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">align_addr</span></font></font>，这个地址就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>对应<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>的地址。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第二步，检查<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">align_addr</span></font></font>是否和静态局部变量<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">save_align_addr</span></font></font>相同，如果相同表明前面已经对这个物理地址的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>进行过请求，已经取得了翻译前需要的各种指针，都存在静态局部变量中，所以跳过分配<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>的代码直接执行指令翻译的代码。注意<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">save_align_addr</span></font></font>的初始值为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0x1</span></font></font>是为了保证不跟任何地址一样。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第三步，这里开始的就是对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>进行分配的代码，首先判断<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt_table_size</span></font></font>是否为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>来确定<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_t</span></font></font>是否是动态分配的。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第四步，如果是动态分配，就会以哈希计算的方法从<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt_table</span></font></font>中取出跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">align_addr</span></font></font>对应地址的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_t</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">比较<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;addr</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">align_addr</span></font></font>，如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;addr</span></font></font>跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">align_addr</span></font></font>不同表明其先前是其他地址的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>，就会进行一些清除过去记录的工作，设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;ted</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;addr</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">align_addr</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">然后就是取得<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;tbp</span></font></font>也就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP</span></font></font>。如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;tbp</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">NULL</span></font></font>，则表明这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP</span></font></font>没有分配或者已经被其他<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>使用，这时候需要调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb.c:tb_get_tbp</span></font></font>进行<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP</span></font></font>的分配。如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;tbp</span></font></font>不为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">NULL</span></font></font>，则<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP</span></font></font>已经分配过，则按照前面在介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;list</span></font></font>那样，先将其从<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_dynamic_list</span></font></font>链表中删除掉。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第五步，如果不是动态分配，首先通过函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb.c:tb_get_mbp</span></font></font>取得<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">align_addr</span></font></font>对应模拟内存的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">mem_bank_t</span></font></font>结构指针<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">mbp</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">检查结构中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">state-&gt;mem.tbt[bank_num]</span></font></font>是否为空，如果为空表明<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp</span></font></font>未分配相应的空间，如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_dynamic</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>表明是静态分配<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP</span></font></font>，则将先给<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">state-&gt;mem.tbp[bank_num]</span></font></font>分配空间，然后给<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">state-&gt;mem.tbt[bank_num]</span></font></font>分配空间。</p>
<p style="margin-bottom: 0cm; line-height: 100%">分配好空间后设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>结构。</p>
<p style="margin-bottom: 0cm; line-height: 100%">在取得<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>结构后检查<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;tbp</span></font></font>也就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP</span></font></font>是否为空。如果为空就根据<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_dynamic</span></font></font>对其进行设置，动态分配跟前面一样使用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb.c:tb_get_tbp</span></font></font>函数，静态从<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">state-&gt;mem.tbp[bank_num]</span></font></font>中取得。如果不为空也跟前面一样判断<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_dynamic</span></font></font>根据情况将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>结构从列表中删除。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">现在，<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>结构和其中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP</span></font></font>都已经取得。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第六步，用取得的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>进行一些设置。</p>
<p style="margin-bottom: 0cm; line-height: 100%">设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">state-&gt;tb_now</span></font></font>为刚取得的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>结构，其的作用是微指令在运行的时候可以访问当前运行的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>，比如在标记<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>为脏之后，微指令可以马上判断出来然后退出。</p>
<p style="margin-bottom: 0cm; line-height: 100%">设置为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">save_align_addr</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">align_addr</span></font></font>，目的在第二步介绍过。</p>
<p style="margin-bottom: 0cm; line-height: 100%">如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_dynamic</span></font></font>为真表明是动态<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP</span></font></font>分配，将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>结构增加到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_dynamic_list</span></font></font>链表的最后面，这么作的目的在介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;list</span></font></font>已经介绍过。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第七步，现在开始的就是对被模拟指令进行翻译的代码。先判断<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;ted</span></font></font>的值来确定这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>结构是否被翻译过。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第八步，如果这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>结构已经翻译过。</p>
<p style="margin-bottom: 0cm; line-height: 100%">先检查<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;last_addr</span></font></font>是否跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>相同，如果相同就返回<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;last_tbp</span></font></font>。这里在前面介绍<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;last_addr</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;last_tbp</span></font></font>的已经介绍过了。</p>
<p style="margin-bottom: 0cm; line-height: 100%">判断需要翻译的物理地址<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>是否大于等于<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;tran_addr</span></font></font>，这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;tran_addr</span></font></font>在前面也介绍过。</p>
<p style="margin-bottom: 0cm; line-height: 100%">如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>小于<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;tran_addr</span></font></font>则表明<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>中现有微指令代码已经可以满足<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>的需要，直接从<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;insn_addr</span></font></font>取出跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>对应的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP</span></font></font>地址作为返回值设置到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ret</span></font></font>就可以。</p>
<p style="margin-bottom: 0cm; line-height: 100%">如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>大于等于<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;tran_addr</span></font></font>则表明需要继续翻译，首先取得跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;tran_addr</span></font></font>地址对应的在被模拟内存块中指针<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">real_begin_addr</span></font></font>，以及和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>对应的在被模拟内存块中指针<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">real_addr</span></font></font>。然后就调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb.c:tb_translate</span></font></font>从给定的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">real_begin_addr</span></font></font>开始的内存进行翻译。最后取得跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>对应的微指令地址设置到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ret</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第九步，如果这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>结构还没有翻译过，就需要重新翻译。</p>
<p style="margin-bottom: 0cm; line-height: 100%">也是首先取得跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;tran_addr</span></font></font>地址对应的在被模拟内存块中指针<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">real_begin_addr</span></font></font>，以及和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>对应的在被模拟内存块中指针<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">real_addr</span></font></font>。然后初始化<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;tran_addr</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">align_addr</span></font></font>，初始化<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;tbp_now</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp</span></font></font>，这两个成员变量在前面介绍过，这里就不再介绍。调用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb.c:tb_translate</span></font></font>从给定的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">real_begin_addr</span></font></font>开始的内存进行翻译。最后取得跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>对应的微指令地址设置到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ret</span></font></font>。并且设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;ted</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">1</span></font></font>表明这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>已经被翻译过。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">现在返回值<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ret</span></font></font>，也就是跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ADDR</span></font></font>对应的微指令地址已经取得。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第十步，将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ret</span></font></font>都设置到<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;last_addr</span></font></font>和<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;last_tbp</span></font></font>上，将<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ret</span></font></font>返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">6.3.tb.c:tb_get_tbp</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数用来对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP</span></font></font>进行动态分配。下面介绍执行过程：</p>
<p style="margin-bottom: 0cm; line-height: 100%">第一步，判断<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_now_size</span></font></font>是否为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，前面介绍过<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_now_size</span></font></font>记录了可以分配的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp</span></font></font>的长度。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第二步，如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_now_size</span></font></font>不是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，表明还可以直接从<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_now</span></font></font>中分配<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第三部，如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_now_size</span></font></font>是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，表明<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_now</span></font></font>中的空间已经分配光了，这时就要取<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp_dynamic_list</span></font></font>的第一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>结构中的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP</span></font></font>，这是整个链表中最不常用的一个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>结构，原因见上面对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;list</span></font></font>的介绍。在取完后要将被取走<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TBP</span></font></font>的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>结构从链表中删除，同时标记其<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">NULL</span></font></font>还有<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ted</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">6.4.tb.c:tb_translate</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数从指定参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_begin_addr</span></font></font>开始的内存进行指令翻译，最后将跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>对应的微指令地址返回。下面介绍执行过程：</p>
<p style="margin-bottom: 0cm; line-height: 100%">第一步，用<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_begin_addr</span></font></font>通过计算取得这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>对应被模拟内存块结束的地址<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_end_addr</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第二步，初始化链表<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_branch_save_list</span></font></font>，这个链表的作用是记录每个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>内跳转，因为在翻译的过程中后面的指令地址还不知道，无法计算跳转长度，所以在这里将要写入的地址以及要跳转到的地址等信息记录起来，待翻译结束后，再循环对连表中的每个跳转长度进行设置。</p>
<p style="margin-bottom: 0cm; line-height: 100%">设置全局变量<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">now_tbt</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt</span></font></font>，这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">now_tbt</span></font></font>是给每个翻译函数可以方便访问当前<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>结构。</p>
<p style="margin-bottom: 0cm; line-height: 100%">设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;ret_addr</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，目的见前面对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ret_addr</span></font></font>的介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第三步，下面开始循环翻译，每次都会检查<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_begin_addr</span></font></font>是否小于<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_end_addr</span></font></font>，如果是就翻译，如果不是就不再进行循环。在每次一条指令翻译结束最后，都会给<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_begin_addr</span></font></font>增加<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ARMword</span></font></font>的长度到下一条指令。下面开始介绍一条指令的翻译过程。</p>
<p style="margin-bottom: 0cm; line-height: 100%">检查<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_begin_addr</span></font></font>是否跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>相同，如果相同表明将翻译的指令是跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>相关的指令，设置返回值<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ret</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;tbp_now</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">设置<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;insn_addr</span></font></font>，这样做的目的见前面对<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;insn_addr</span></font></font>的介绍。</p>
<p style="margin-bottom: 0cm; line-height: 100%">以当前要翻译的指令<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">*tb_begin_addr</span></font></font>、当前写入微指令的指针<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;tbp_now</span></font></font>等为参数，对函数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb.c:translate_word</span></font></font>进行调用，这个函数就是对某个指令进行翻译的函数，其会返回写入微指令的长度<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">len</span></font></font>。</p>
<p style="margin-bottom: 0cm; line-height: 100%">给<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;tbp_now</span></font></font>增加<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">len</span></font></font>，跳过已经使用的伪指令存储空间。</p>
<p style="margin-bottom: 0cm; line-height: 100%">给<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;tran_addr</span></font></font>加<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">4</span></font></font>，令其对应下一个指令。</p>
<p style="margin-bottom: 0cm; line-height: 100%">最后就是前面介绍过的如果指令一定发生返回就中断翻译。这里先要提一下<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">state-&gt;trap</span></font></font>，前面提过其在微指令执行时候的作用是返回异常类型，其在指令翻译的时候的作用是标记前面翻译的指令是肯定返回。这里就可以看到在检查了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">state-&gt;trap</span></font></font>的同时，还检查了<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ret</span></font></font>以及<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;tran_addr</span></font></font>是否大于<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbt-&gt;ret_addr</span></font></font>，这些工作的目的在前面都介绍过。如果确定可以停止翻译，就终端循环。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第四步，这时已经翻译指令结束，判断如果<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>已经被全部翻译，也就是<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">state-&gt;trap</span></font></font>为<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">0</span></font></font>，在最后加上<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">op_return</span></font></font>微指令，让这个<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">TB</span></font></font>执行结束后返回。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">第五步，现在将前面介绍过的<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tb_branch_save_list</span></font></font>链表中的每个跳转结构依次取出，进行设置。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%">最后返回<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">ret</span></font></font>也就是跟<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">addr</span></font></font>对应的伪指令地址。</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><br>
</p>
<p style="margin-bottom: 0cm; line-height: 100%"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">6.5.tb.c:translate_word</span></font></font></p>
<p style="margin-bottom: 0cm; line-height: 100%">这是对参数中一个被模拟指令<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">insn</span></font></font>翻译成微指令并存储到参数<font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span lang="en-US">tbp</span></font></font>中最后将写入的微指令长度返回的函数。</p>
<p style="margin-bottom: 0cm; line-height: 100%">这个函数本身结构比较大，而且主要都是指令翻译的工作，所以不做详细介绍了。</p>
</body>
</html>